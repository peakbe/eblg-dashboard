<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>EBLG ‚Äì FIDS, METAR, Bruit (Diapason), ADS‚ÄëB & Sonom√®tres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Styles -->
  <style>
    body { margin:0; font-family:system-ui; display:flex; flex-direction:column; height:100vh; }
    header { background:#111827; color:#f9fafb; padding:0.5rem 1rem; display:flex; justify-content:space-between; }
    main { display:grid; grid-template-columns:320px 1fr; flex:1; }
    #sidebar { padding:1rem; overflow-y:auto; border-right:1px solid #ddd; font-size:0.85rem; }
    #map { width:100%; height:100%; }
    .block { margin-bottom:1rem; border-bottom:1px solid #ddd; padding-bottom:1rem; }
    .metar { background:#f3f4f6; padding:0.4rem; border-radius:4px; font-family:monospace; }
    .small { font-size:0.75rem; color:#555; }
    .tag { background:#eee; padding:2px 6px; border-radius:4px; font-size:0.7rem; }
    .tag.impacted { background:#b91c1c; color:white; }
    .flight-row { padding:4px 0; cursor:pointer; }
    .flight-row:hover { background:#f3f4f6; }
    button.tag { cursor:pointer; border:none; background:#e5e7eb; padding:3px 8px; border-radius:4px; margin-right:4px; }
    button.tag:hover { background:#d1d5db; }
    @media(max-width:768px){
      main{display:flex; flex-direction:column;}
      #sidebar{border-right:none; border-bottom:1px solid #ddd; max-height:45vh;}
      #map{height:55vh;}
    }
  </style>

  <!-- Leaflet JS + Heatmap -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SignalR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
</head>
<body>
<header>
  <h1>EBLG ‚Äì FIDS + METAR + Bruit (Diapason) + ADS‚ÄëB</h1>
  <div class="small">Interface consolid√©e</div>
</header>

<main>
  <section id="sidebar">
    <div class="block">
      <h2>M√©t√©o EBLG</h2>
      <div id="meteo-summary" class="small">Chargement...</div>
      <div id="meteo-raw" class="metar"></div>
    </div>

    <div class="block">
      <h2>Piste & couloir bruit</h2>
      <div id="runway-info" class="small">Analyse...</div>
    </div>

    <div class="block">
      <h2>Sonom√®tres impact√©s</h2>
      <div id="sonos-impacted" class="small">En attente...</div>
    </div>

    <div class="block">
      <h2>Bruit en temps r√©el (Diapason)</h2>
      <div id="noise-live" class="small">Connexion...</div>
    </div>

    <div class="block">
      <h2>Alertes</h2>
      <div id="alerts" class="small">Aucune alerte.</div>
    </div>

    <div class="block">
      <h2>Vols (FIDS)</h2>
      <div>
        <button class="tag" onclick="setFilter('ALL')">ALL</button>
        <button class="tag" onclick="setFilter('ARR')">ARR</button>
        <button class="tag" onclick="setFilter('DEP')">DEP</button>
      </div>
      <div id="flights-list" class="small">Chargement...</div>
    </div>

    <div class="block">
      <h2>D√©tail du vol</h2>
      <div id="flight-detail" class="small">S√©lectionnez un vol‚Ä¶</div>
    </div>
  </section>

  <section id="map"></section>
</main>

<script>
/* ================================
   CONFIG
================================ */
const AVWX_TOKEN = "ersegQzkf2Dfal-o26B4b5uzMrXBeHK2jOpOaY7nffc";
const PROXY = "https://eblg-proxy.onrender.com/fids?url=";
const URL_ARR = PROXY + encodeURIComponent("https://fids.liegeairport.com/api/flights/Arrivals");
const URL_DEP = PROXY + encodeURIComponent("https://fids.liegeairport.com/api/flights/Departures");

const EBLG = {
  lat: 50.6374,
  lon: 5.4432,
  runways: [
    { name:"04", heading: 40 },
    { name:"22", heading:220 }
  ]
};

let FLT_FILTER = "ALL";
let lastHeading = null;
let lastRunway = null;

/* ================================
   HELPERS FIDS ‚Üî ADS-B
================================ */
function normalizeCallsign(cs) {
  if (!cs) return "";
  return String(cs).toUpperCase().trim().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"").slice(0,8);
}
let ADSB_BY_CALLSIGN = {}; // { norm: {icao, marker} }
let LAST_FIDS = null;      // dernier fids affich√©

/* ================================
   SONOM√àTRES (coordonn√©es corrig√©es)
================================ */
const SONOS = [
  {id:"F017",lat:50.764883,lon:5.630606,addr:"Rue de la Pommeraie, 4690 Wonck"},
  {id:"F001",lat:50.738044,lon:5.608833,addr:"Rue Franquet, Houtain"},
  {id:"F014",lat:50.718894,lon:5.573164,addr:"Rue L√©on Labaye, Juprelle"},
  {id:"F015",lat:50.688839,lon:5.526217,addr:"Rue du Brouck, Juprelle"},
  {id:"F005",lat:50.639331,lon:5.323519,addr:"Rue Caquin, Haneffe"},
  {id:"F003",lat:50.601167,lon:5.381400,addr:"Rue Fond M√©an, St Georges"},
  {id:"F011",lat:50.601142,lon:5.356006,addr:"Rue Albert 1er, St Georges"},
  {id:"F008",lat:50.594878,lon:5.358950,addr:"Rue Warfus√©e, St Georges"},
  {id:"F002",lat:50.588414,lon:5.370522,addr:"Rue Noiset, St Georges"},
  {id:"F007",lat:50.590756,lon:5.345225,addr:"Rue Yernawe, St Georges"},
  {id:"F009",lat:50.580831,lon:5.355417,addr:"Biblioth√®que, Place Verte, Stockay"},
  {id:"F004",lat:50.605414,lon:5.321406,addr:"Vin√¢ve des Str√©ats, Verlaine"},
  {id:"F010",lat:50.599392,lon:5.313492,addr:"Rue Haute Voie, Verlaine"},
  {id:"F013",lat:50.586914,lon:5.308678,addr:"Rue Bois L√©on, Verlaine"},
  {id:"F016",lat:50.619617,lon:5.295344,addr:"Rue de Chapon-Seraing, Verlaine"},
  {id:"F006",lat:50.609594,lon:5.271403,addr:"Rue Bolly Chapon, Seraing"},
  {id:"F012",lat:50.621917,lon:5.254747,addr:"Rue Barbe d'Or, Aineffe"}
];

const COLOR = { green:"#10b981", red:"#ef4444", gray:"#6b7280" };
const RW22_TKOFF_GREEN = new Set(["F002","F003","F004","F005","F006","F007","F008","F009","F010","F011","F012","F013","F016"]);
const RW04_LDG_GREEN   = new Set(["F002","F003","F007","F008","F009","F011","F013"]);
const RW04_BOTH_GREEN  = new Set(["F001","F014","F015","F017"]); // F017 sera surcharg√© √† chaud
const RW04_LDG_IMP_RED = new Set(["F004","F005","F006","F010","F012","F016"]);

/* ================================
   MAP
================================ */
const map = L.map("map").setView([EBLG.lat,EBLG.lon], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

L.circleMarker([EBLG.lat,EBLG.lon],{radius:7,color:"#10b981",fillColor:"#10b981",fillOpacity:1})
  .addTo(map)
  .bindPopup("EBLG ‚Äì Li√®ge Airport");

const SONO_MARKERS = SONOS.map(s=>{
  const marker = L.circleMarker([s.lat,s.lon],{
    radius:5,color:COLOR.gray,fillColor:COLOR.gray,fillOpacity:1
  })
  .addTo(map)
  .bindPopup(`
    <strong>${s.id}</strong><br>${s.addr}<br>
    <span id="lv_${s.id}">niveau: ‚Ä¶ dB(A)</span><br><br>
    <canvas id="chart_${s.id}" width="250" height="120"></canvas>
  `);
  return {...s, marker};
});

/* ================================
   UTILITAIRES G√âO
================================ */
function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function computePoint([lat,lon],heading,km){
  const R=6371;
  const d=km/R;
  const br=toRad(heading);
  const la=toRad(lat), lo=toRad(lon);
  const la2=Math.asin(Math.sin(la)*Math.cos(d)+Math.cos(la)*Math.sin(d)*Math.cos(br));
  const lo2=lo+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(la),Math.cos(d)-Math.sin(la)*Math.sin(la2));
  return [toDeg(la2),toDeg(lo2)];
}

function distanceKm(lat1,lon1,lat2,lon2){
  const R=6371, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// distance point ‚Üí segment (km)
function distancePointToSegmentKm(p, a, b){
  // convert to planar approx using lat/long degrees to km near EBLG
  const kx = 111*Math.cos(toRad((a[0]+b[0])/2)); // km per degree lon
  const ky = 111;                                 // km per degree lat
  const px=(p[1]-a[1])*kx, py=(p[0]-a[0])*ky;
  const bx=(b[1]-a[1])*kx, by=(b[0]-a[0])*ky;
  const t=Math.max(0,Math.min(1, (px*bx+py*by)/(bx*bx+by*by || 1)));
  const qx = t*bx, qy = t*by;
  const dx = px-qx, dy = py-qy;
  return Math.sqrt(dx*dx+dy*dy);
}

// point-in-polygon exact (ray casting)
function pointInPolygon(point, polygon){
  const [lat,lon]=point;
  let inside=false;
  for (let i=0,j=polygon.length-1;i<polygon.length;j=i++){
    const [lati,loni]=polygon[i], [latj,lonj]=polygon[j];
    const intersect = ((loni>lon)!=(lonj>lon)) &&
      (lat < (latj-lati)*(lon-loni)/(lonj-loni+1e-12)+lati);
    if (intersect) inside=!inside;
  }
  return inside;
}

/* ================================
   RUNWAY 04 ‚Äì GEOMETRIE R√âELLE
================================ */
// Approximations r√©alistes des seuils de piste (ajuste si besoin)
const RWY04_START = [50.637950, 5.443800]; // seuil piste 04 (proche aerodrome ref)
const RWY04_END   = [50.643600, 5.452000]; // extr√©mit√© piste 04
const RWY04_HEADING = 40;

// largeur piste ~ 60 m ‚Üí 0.06 km (demi-largeur = 0.03 km)
const RWY_HALF_WIDTH_KM = 0.03;

// Polygone piste √©troit align√©
const RWY04_POLY = [
  computePoint(RWY04_START, RWY04_HEADING - 90, RWY_HALF_WIDTH_KM),
  computePoint(RWY04_END,   RWY04_HEADING - 90, RWY_HALF_WIDTH_KM),
  computePoint(RWY04_END,   RWY04_HEADING + 90, RWY_HALF_WIDTH_KM),
  computePoint(RWY04_START, RWY04_HEADING + 90, RWY_HALF_WIDTH_KM)
];

// (Optionnel) visualiser la piste
// L.polygon(RWY04_POLY, {color:'#666', weight:1}).addTo(map);

// zone prolong√©e (couloir) pour mont√©e initiale : bande ¬±0.5 km autour de l‚Äôaxe jusqu‚Äô√† 6 km
function buildExtendedCenterlinePoly(start, end, halfWidthKm, lengthKm){
  const axisHeading = RWY04_HEADING;
  const axisEnd = computePoint(start, axisHeading, lengthKm);
  const leftStart  = computePoint(start, axisHeading-90, halfWidthKm);
  const rightStart = computePoint(start, axisHeading+90, halfWidthKm);
  const leftEnd    = computePoint(axisEnd, axisHeading-90, halfWidthKm);
  const rightEnd   = computePoint(axisEnd, axisHeading+90, halfWidthKm);
  return [leftStart,leftEnd,rightEnd,rightStart];
}
const RWY04_EXT_POLY = buildExtendedCenterlinePoly(RWY04_END, RWY04_START, 0.5, 6);

/* ================================
   ADS‚ÄëB ‚Äì OpenSky (index par callsign)
================================ */
let ADSB_MARKERS = {};
let ADSB_TRACKS  = {};

async function fetchADSB(){
  const url="https://opensky-network.org/api/states/all?lamin=50.3&lomin=5.1&lamax=50.9&lomax=5.8";
  try{
    const r = await fetch(url);
    const j = await r.json();
    return j.states || [];
  }catch(e){ return []; }
}

function updateADSB(states){
  states.forEach(s=>{
    const icao=(s[0]);
    const callsign=(s[1]||"").trim();
    const lon=s[5], lat=s[6];
    if (lat == null || lon == null) return;

    // Cr√©ation / mise √† jour du marker
    if (!ADSB_MARKERS[icao]){
      ADSB_MARKERS[icao]=L.circleMarker([lat,lon],{
        radius:6,color:"#f59e0b",fillColor:"#f59e0b",fillOpacity:0.9
      })
      .addTo(map)
      .bindPopup(`ICAO: ${icao}<br>Callsign: ${callsign}`);
    } else {
      ADSB_MARKERS[icao].setLatLng([lat,lon]);
    }

    // Historique de trajectoire
    if (!ADSB_TRACKS[icao]) ADSB_TRACKS[icao]=[];
    ADSB_TRACKS[icao].push([lat,lon]);
    if (ADSB_TRACKS[icao].length>40) ADSB_TRACKS[icao].shift();
    if (ADSB_TRACKS[icao].poly) map.removeLayer(ADSB_TRACKS[icao].poly);
    ADSB_TRACKS[icao].poly = L.polyline(ADSB_TRACKS[icao],{color:"#fbbf24",weight:2}).addTo(map);

    // Index par callsign normalis√©
    const norm = normalizeCallsign(callsign);
    if (norm) {
      ADSB_BY_CALLSIGN[norm] = { icao, marker: ADSB_MARKERS[icao] };
      // Click marker ‚Üí montrer vol FIDS li√© (si connu)
      ADSB_MARKERS[icao].off("click");
      ADSB_MARKERS[icao].on("click", ()=>{
        if (!LAST_FIDS) return;
        const all = [...(LAST_FIDS.arrivals||[]), ...(LAST_FIDS.departures||[])];
        const match = all.find(v => normalizeCallsign(v.flightPax||v.flight||v.callsign) === norm);
        if (match) showFlightDetail(match);
      });
    }
  });

  // D√©tection d√©collage RWY 04 + VR + survol F017
  detectTakeoff04(states);

  // MAJ couleurs sonos imm√©diatement (sans attendre le prochain refresh())
  if (lastRunway) colorSonoByRunway(lastRunway);
  updateF017Icon();

  // Apr√®s rafra√Æchissement ADS‚ÄëB, on met √† jour les badges dans la liste FIDS
  annotateFlightsWithADSB();
}

function annotateFlightsWithADSB() {
  try {
    const el = document.getElementById("flights-list");
    if (!el) return;
    el.querySelectorAll(".flight-row").forEach(row => {
      const norm = row.getAttribute("data-normcallsign");
      const badge = row.querySelector(".adsb-badge");
      const hasAdsb = norm && !!ADSB_BY_CALLSIGN[norm];
      if (badge) {
        badge.textContent = hasAdsb ? "ADS‚ÄëB OK" : "‚Äî";
        badge.style.background = hasAdsb ? "#10b981" : "#d1d5db";
        badge.style.color = hasAdsb ? "#fff" : "#111";
      }
    });
  } catch(e) { /* noop */ }
}

function focusAircraftByCallsign(norm, v) {
  const hit = norm ? ADSB_BY_CALLSIGN[norm] : null;
  if (hit && hit.marker) {
    const mk = hit.marker;
    const ll = mk.getLatLng();
    map.setView(ll, 13);
    mk.openPopup();
    // ping visuel
    const ping = L.circle(ll, {radius:150, color:"#22c55e", weight:2, fillOpacity:0.1});
    ping.addTo(map);
    setTimeout(()=> map.removeLayer(ping), 2500);
  } else {
    // repli si pas de match
    highlightFlightOnMap(v);
  }
}

/* ================================
   METAR
================================ */
async function fetchMetar(){
  const url = `https://avwx.rest/api/metar/EBLG?token=${AVWX_TOKEN}&format=json`;
  const r = await fetch(url);
  return r.json();
}
function updateMetarUI(m){
  document.getElementById("meteo-summary").textContent =
    `Vent ${m.wind_direction.value}¬∞ / ${m.wind_speed.value} kt ‚Äì T¬∞ ${m.temperature.value}¬∞C`;
  document.getElementById("meteo-raw").textContent = m.raw;
}
function formatLocal(t){
  if(!t) return "-";
  return new Date(t).toLocaleTimeString("fr-BE",{hour:"2-digit",minute:"2-digit",hour12:false});
}

/* ================================
   FIDS (avec annotation ADS‚ÄëB)
================================ */
async function fetchFIDS(){
  const arr = await fetch(URL_ARR).then(r=>r.json());
  const dep = await fetch(URL_DEP).then(r=>r.json());
  return {
    arrivals: Array.isArray(arr)?arr:[],
    departures: Array.isArray(dep)?dep:[]
  };
}
function setFilter(f){ FLT_FILTER=f; refresh(); }

function updateFlightsUI(f){
  LAST_FIDS = f;  // m√©morise pour interactions ult√©rieures

  const el = document.getElementById("flights-list");
  let all=[...f.arrivals, ...f.departures];

  if (FLT_FILTER==="ARR") all = all.filter(v=>v.direction==="Arrivals");
  if (FLT_FILTER==="DEP") all = all.filter(v=>v.direction==="Departures");

  all.sort((a,b)=> new Date(a.sTx)-new Date(b.sTx));
  all = all.slice(0, 10);

  if(!all.length){ el.textContent="Aucun vol."; return; }

  el.innerHTML = all.map(v=>{
    const rawCs = v.flightPax || v.flight || v.callsign || "";
    const norm = normalizeCallsign(rawCs);
    const hasAdsb = norm && !!ADSB_BY_CALLSIGN[norm];
    const rwy = v.runway || "?";
    return `
      <div class="flight-row" data-id="${v.id}" data-normcallsign="${norm}">
        ${v.direction==="Arrivals" ? "ARR" : "DEP"} ${rawCs}
        (${v.aircraftType}) ‚Äì RWY ${rwy}
        <span class="tag adsb-badge" style="margin-left:6px; ${hasAdsb ? 'background:#10b981;color:#fff;' : ''}">
          ${hasAdsb ? 'ADS‚ÄëB OK' : '‚Äî'}
        </span>
        <br>
        ${formatLocal(v.sTx)} ‚Üí ${formatLocal(v.eTx)}
      </div>
    `;
  }).join("");

  el.querySelectorAll(".flight-row").forEach(row=>{
    row.onclick = ()=>{
      const id = row.getAttribute("data-id");
      const norm = row.getAttribute("data-normcallsign");
      const flight = all.find(v=> v.id === id);
      if (flight) showFlightDetail(flight);
      focusAircraftByCallsign(norm, flight);
    };
  });

  // Badge instantan√© m√™me avant update ADS-B suivant
  annotateFlightsWithADSB();
}

function showFlightDetail(v){
  document.getElementById("flight-detail").innerHTML = `
    <strong>${v.flightPax}</strong> ‚Äì ${v.aircraftType}<br>
    ${v.origin} ‚Üí ${v.destination}<br>
    Piste : ${v.runway||"-"}<br>
    STD/STA : ${formatLocal(v.sTx)}<br>
    ETD/ETA : ${formatLocal(v.eTx)}<br>
    ATD/ATA : ${formatLocal(v.aTx)}<br>
    Stand : ${v.stand||"-"}<br>
    Op√©rateur : ${v.operator||"-"}
  `;
}
function highlightFlightOnMap(v){
  if(!v) return;
  const pos=[EBLG.lat+0.005,EBLG.lon+0.005];
  if (window.flightMarker) map.removeLayer(window.flightMarker);
  window.flightMarker = L.circleMarker(pos,{radius:10,color:"#f97316",fillColor:"#f97316",fillOpacity:0.9})
    .addTo(map).bindPopup(`Vol ${v.flightPax}`);
  map.setView(pos,13);
}

/* ================================
   RUNWAY + COULOIR BRUIT + HEATMAP
================================ */
function extractRunway(f){
  const all=[...f.arrivals,...f.departures];
  const r = all.find(v=>v.runway);
  if(!r) return null;
  const name = r.runway.replace(/[^0-9]/g,"");
  return EBLG.runways.find(x=>x.name===name) || null;
}
function runwayFromMetar(m){
  if (!m || !m.wind_direction || m.wind_direction.value==null) return null;
  const wd=m.wind_direction.value;
  let best=null, bestDiff=999;
  EBLG.runways.forEach(rw=>{
    const diff=Math.min(Math.abs(wd-rw.heading),360-Math.abs(wd-rw.heading));
    if(diff<bestDiff){bestDiff=diff; best=rw;}
  });
  return best;
}
function buildCorridor(h){
  const start=[EBLG.lat,EBLG.lon];
  const end=computePoint(start,h,20);
  const leftStart= computePoint(start,h-90,1.5);
  const rightStart=computePoint(start,h+90,1.5);
  const leftEnd=  computePoint(end,  h-90,3.5);
  const rightEnd= computePoint(end,  h+90,3.5);
  return [leftStart,leftEnd,rightEnd,rightStart];
}
function colorSonoByRunway(rwy){
  SONO_MARKERS.forEach(s=>{
    let style={color:COLOR.gray,fillColor:COLOR.gray};

    // üî¥ F017 rouge UNIQUEMENT pendant le d√©collage r√©el RWY 04 (course + mont√©e < 200 ft)
    if (s.id === "F017" && IS_TAKEOFF_04) {
      style={color:COLOR.red,fillColor:COLOR.red};
    }
    else if (rwy==="22"){
      if (RW22_TKOFF_GREEN.has(s.id)) style={color:COLOR.green,fillColor:COLOR.green};
    } else if (rwy==="04"){
      if (RW04_LDG_IMP_RED.has(s.id)) style={color:COLOR.red,fillColor:COLOR.red};
      else if (RW04_LDG_GREEN.has(s.id) || RW04_BOTH_GREEN.has(s.id))
        style={color:COLOR.green,fillColor:COLOR.green};
    }
    s.marker.setStyle({...style,fillOpacity:1});
  });
}
function computeImpacted(h){
  const poly=buildCorridor(h);
  if (corridorLayer) map.removeLayer(corridorLayer);
  corridorLayer = L.polygon(poly,{color:"#f97316",weight:2,fillOpacity:0.15}).addTo(map);
  const impacted=[];
  SONO_MARKERS.forEach(s=>{
    const inside = L.polygon(poly).getBounds().contains([s.lat,s.lon]);
    if (inside) impacted.push(s);
  });
  return impacted;
}
function updateHeatmap(imp){
  const pts=SONOS.map(s=>{
    const isImp=imp.find(i=>i.id===s.id);
    return [s.lat,s.lon,isImp?1.5:0.3];
  });
  if (heatLayer) map.removeLayer(heatLayer);
  if (window.L && L.heatLayer) {
    heatLayer = L.heatLayer(pts,{radius:40,blur:25,maxZoom:12}).addTo(map);
  }
}

/* ================================
   DIAPASON ‚Äì SIGNALR BRUIT TEMPS R√âEL + Graphiques
================================ */
const HUB_URL="https://eblg.aerovision.cloud/EBLG/signalr-noise";
const SENSOR_MAP={
  1:"F001",2:"F002",3:"F003",4:"F004",5:"F005",
  6:"F006",7:"F007",8:"F008",9:"F009",10:"F010",
  11:"F011",12:"F012",13:"F013",14:"F014",
  15:"F015",16:"F016",17:"F017"
};
let LIVE_NOISE = {};

// Historique LAeq par capteur (5 minutes)
const HISTORY_DURATION_MS = 5 * 60 * 1000;
let NOISE_HISTORY = {};
SONOS.forEach(s => NOISE_HISTORY[s.id] = []);

// Store des graphes Chart.js
let CHARTS = {};

const connection=new signalR.HubConnectionBuilder()
  .withUrl(HUB_URL)
  .withAutomaticReconnect()
  .build();

connection.on("addNoiseMeasure",(sensorId,payload)=>{
  const fId = SENSOR_MAP[sensorId] || `ID_${sensorId}`;

  LIVE_NOISE[fId] = {
    laeq: payload.value,
    t: new Date(payload.timeStamp).toISOString()
  };

  // Historique glissant
  const now = Date.now();
  NOISE_HISTORY[fId].push({ t: now, v: payload.value });
  NOISE_HISTORY[fId] = NOISE_HISTORY[fId].filter(p => now - p.t <= HISTORY_DURATION_MS);

  // MAJ graphe si popup ouverte
  updateHistoryChart(fId);

  // MAJ panneau lat√©ral
  updateNoiseUI(Object.entries(LIVE_NOISE).map(([id,v])=>({id,laeq:v.laeq,t:v.t})));

  // MAJ texte popup
  const span=document.getElementById(`lv_${fId}`);
  if (span) span.textContent=`niveau: ${payload.value} dB(A)`;
});

connection.start().catch(console.error);

function updateNoiseUI(list){
  const box=document.getElementById("noise-live");
  if (!list || !list.length){
    box.textContent="Aucune donn√©e.";
    return;
  }
  box.innerHTML = list
    .sort((a,b)=> a.id>b.id?1:-1)
    .map(v=>`<div><strong>${v.id}</strong> : ${v.laeq ?? "n/d"} dB(A)</div>`)
    .join("");
}

function updateHistoryChart(fId){
  const canvas = document.getElementById(`chart_${fId}`);
  if (!canvas) return; // popup pas ouverte

  const data = NOISE_HISTORY[fId];
  const labels = data.map(p => new Date(p.t).toLocaleTimeString("fr-BE",{minute:"2-digit",second:"2-digit"}));
  const values = data.map(p => p.v);

  if (!CHARTS[fId]){
    CHARTS[fId] = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'LAeq (dB)',
          data: values,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.2)',
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 0
        }]
      },
      options: {
        animation: false,
        scales: {
          x: { display: true },
          y: { min: 20, max: 90 }
        },
        plugins:{ legend: { display:false } }
      }
    });
  } else {
    CHARTS[fId].data.labels = labels;
    CHARTS[fId].data.datasets[0].data = values;
    CHARTS[fId].update();
  }
}

/* ================================
   ALERTES
================================ */
function computeAlerts(m,rw){
  const a=[];
  if (m.wind_speed.value>25) a.push("Vent fort (>25 kt)");
  if (m.wind_gust && m.wind_gust.value>35) a.push("Rafales (>35 kt)");
  if (rw && m.wind_direction){
    const diff=Math.abs(m.wind_direction.value - rw.heading);
    if (diff>150 && diff<210) a.push("Vent arri√®re");
  }
  if (lastRunway && rw && lastRunway!==rw.name)
    a.push(`Changement piste : ${lastRunway} ‚Üí ${rw.name}`);
  lastRunway=rw?rw.name:null;

  document.getElementById("alerts").innerHTML =
    a.length ? a.map(x=>`<div>‚ö†Ô∏è ${x}</div>`).join("") : "Aucune alerte.";
}

/* ================================
   D√âTECTION ADS-B D√âCOLLAGE RWY 04
================================ */
// conversions
const MS2KT = 1.943844;
const M2FT  = 3.28084;

// Seuils (r√©glables)
const RWY04_HEADING_TOL = 15;      // ¬±15¬∞
const ROLL_GS_KT        = 70;      // vitesse typique course
const FAST_TAXI_KT      = 40;      // roulage rapide
const VR_GS_KT          = 110;     // proche VR (indicatif)
const CLIMB_MAX_ALT_FT  = 200;     // mont√©e initiale jusqu'√† 200 ft
const CENTERLINE_MAX_OFFSET_KM = 0.5; // demi-largeur du couloir prolong√©

let IS_TAKEOFF_04 = false;
let lastTakeoffTime = 0;

let VR_DETECTED = false;
let VR_LOCATION = null;
let VR_MARKER = null;

// ic√¥ne ‚úàÔ∏è‚¨ÜÔ∏è au-dessus de F017 pendant le d√©collage
const TAKEOFF_ICON = L.divIcon({
  html: "‚úàÔ∏è‚¨ÜÔ∏è",
  className: "takeoff-icon",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});
// injecter style minimal
(function addIconStyle(){
  const st = document.createElement('style');
  st.textContent = `.takeoff-icon{font-size:28px;color:#dc2626;text-shadow:0 0 4px rgba(0,0,0,.6);}`;
  document.head.appendChild(st);
})();
let f017MarkerAbove = null;

function showToast(msgText, bg="#dc2626"){
  const msg = document.createElement("div");
  msg.style.position = "fixed";
  msg.style.top = "20px";
  msg.style.right = "20px";
  msg.style.background = bg;
  msg.style.color = "white";
  msg.style.padding = "12px 18px";
  msg.style.borderRadius = "6px";
  msg.style.fontSize = "16px";
  msg.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
  msg.style.zIndex = 99999;
  msg.style.opacity = "0";
  msg.style.transition = "opacity .2s";
  msg.textContent = msgText;
  document.body.appendChild(msg);
  requestAnimationFrame(()=>{ msg.style.opacity="1"; });
  setTimeout(() => {
    msg.style.opacity = "0";
    setTimeout(() => msg.remove(), 600);
  }, 3500);
}

function showTakeoffNotification(cs){
  showToast(`D√©collage RWY 04 d√©tect√© : ${cs}`, "#dc2626");
}

function updateF017Icon(){
  const f017 = SONOS.find(s => s.id === "F017");
  if (!f017) return;
  if (IS_TAKEOFF_04) {
    if (!f017MarkerAbove) {
      f017MarkerAbove = L.marker([f017.lat, f017.lon], {icon: TAKEOFF_ICON}).addTo(map);
    }
  } else {
    if (f017MarkerAbove) {
      map.removeLayer(f017MarkerAbove);
      f017MarkerAbove = null;
    }
  }
}

// Survol F017 ‚Äì dur√©e exacte
let F017_SURVEY_START = null;
let F017_SURVEY_ACTIVE = false;
function checkF017Overflight(lat, lon){
  const f017 = SONOS.find(s => s.id === "F017");
  if (!f017) return;
  const dist = distanceKm(lat, lon, f017.lat, f017.lon); // km

  // On ne mesure la dur√©e que pendant le d√©collage / mont√©e < 200 ft
  if (!IS_TAKEOFF_04) {
    if (F017_SURVEY_ACTIVE && F017_SURVEY_START){
      const duration = ((Date.now()-F017_SURVEY_START)/1000).toFixed(1);
      showToast(`Survol F017 termin√© ‚Äì dur√©e ${duration} s`, "#0ea5e9");
    }
    F017_SURVEY_ACTIVE = false;
    F017_SURVEY_START = null;
    return;
  }

  if (dist < 0.5) {
    if (!F017_SURVEY_ACTIVE) {
      F017_SURVEY_ACTIVE = true;
      F017_SURVEY_START = Date.now();
      // console.log("D√©but survol F017");
    }
  } else {
    if (F017_SURVEY_ACTIVE && F017_SURVEY_START){
      const duration = ((Date.now()-F017_SURVEY_START)/1000).toFixed(1);
      showToast(`Survol F017 termin√© ‚Äì dur√©e ${duration} s`, "#0ea5e9");
      F017_SURVEY_ACTIVE = false;
      F017_SURVEY_START = null;
    }
  }
}

function angleDiff(a,b){
  let d = Math.abs(a-b) % 360;
  if (d>180) d=360-d;
  return d;
}

function detectTakeoff04(states){
  let detected = false;

  for (const s of states) {
    const callsign = (s[1] || "").trim();
    const lon = s[5];
    const lat = s[6];
    if (lat == null || lon == null) continue;

    const velocity_mps = s[9] || 0;
    const track = (s[10] != null) ? s[10] : null;
    const vrate_mps = (s[11] != null) ? s[11] : null;

    const alt_m = (s[13] != null) ? s[13] : ((s[7] != null) ? s[7] : 0);
    const gs = velocity_mps * MS2KT;
    const alt_ft = (alt_m || 0) * M2FT;

    // Ne consid√©rer que des DEPARTURES RWY 04 connus FIDS
    const norm = normalizeCallsign(callsign);
    let fidsFlight = null;
    if (LAST_FIDS && LAST_FIDS.departures) {
      fidsFlight = LAST_FIDS.departures.find(v =>
        normalizeCallsign(v.flightPax || v.flight || v.callsign) === norm
      );
    }
    if (!fidsFlight) continue;
    if (!((fidsFlight.runway || "").includes("04"))) continue;

    // Avion "sur la piste" = dans polygone √©troit de piste
    const onRunway = pointInPolygon([lat,lon], RWY04_POLY);

    // Heading proche 040¬∞
    const goodHeading = (track != null) ? (angleDiff(track, RWY04_HEADING) <= RWY04_HEADING_TOL) : true;

    // Proximit√© de l'axe prolong√© (pendant mont√©e)
    const axisOffsetKm = distancePointToSegmentKm([lat,lon], RWY04_START, RWY04_END);
    const nearCenterline = axisOffsetKm <= CENTERLINE_MAX_OFFSET_KM;
    const alongRunwayDir = goodHeading; // simple

    // Phases
    const fastTaxi    = gs >= FAST_TAXI_KT;
    const takeoffRoll = onRunway && goodHeading && gs >= ROLL_GS_KT;
    const initialClimb = !onRunway && alongRunwayDir && (gs >= ROLL_GS_KT) && (alt_ft > 0 && alt_ft <= CLIMB_MAX_ALT_FT) && nearCenterline;

    // D√©tection VR (une fois)
    if (!VR_DETECTED && onRunway && goodHeading && gs >= VR_GS_KT && (alt_ft < 50 || (vrate_mps != null && vrate_mps > 0.5))){
      VR_DETECTED = true;
      VR_LOCATION = [lat,lon];
      if (VR_MARKER) map.removeLayer(VR_MARKER);
      VR_MARKER = L.circleMarker(VR_LOCATION, {
        radius:8, color:"#22d3ee", fillColor:"#22d3ee", fillOpacity:0.9
      }).addTo(map).bindPopup("Rotation Point (VR)");
    }

    if (takeoffRoll || initialClimb){
      detected = true;

      if (!IS_TAKEOFF_04) {
        // Premi√®re d√©tection ‚Üí notification
        showTakeoffNotification(callsign || "‚Äî");
      }

      IS_TAKEOFF_04 = true;
      lastTakeoffTime = Date.now();

      // Mesure du survol de F017 (uniquement pendant la phase)
      checkF017Overflight(lat, lon);

      // pas besoin d'examiner d'autres avions si un seul suffit
      // (mais on continue si on veut suivre plusieurs d√©collages simultan√©s)
    }
  }

  // Hyst√©r√©sis : si pause ADS‚ÄëB, conserver 20 s avant extinction
  if (!detected && IS_TAKEOFF_04) {
    if (Date.now() - lastTakeoffTime > 20000) {
      IS_TAKEOFF_04 = false;
      // fin du survol si rest√© actif
      if (F017_SURVEY_ACTIVE && F017_SURVEY_START){
        const duration = ((Date.now()-F017_SURVEY_START)/1000).toFixed(1);
        showToast(`Survol F017 termin√© ‚Äì dur√©e ${duration} s`, "#0ea5e9");
      }
      F017_SURVEY_ACTIVE = false;
      F017_SURVEY_START = null;
    }
  }
}

/* ================================
   MAIN LOOP
================================ */
async function refresh(){
  const metar = await fetchMetar();
  updateMetarUI(metar);

  const fids = await fetchFIDS();
  updateFlightsUI(fids);

  const rwF=extractRunway(fids);
  const rwM=runwayFromMetar(metar);
  const rw = rwF || rwM;

  if (!rw){
    document.getElementById("runway-info").textContent="Piste ind√©termin√©e.";
  } else {
    document.getElementById("runway-info").textContent = `Piste ${rw.name} ‚Äì cap ${rw.heading}¬∞`;

    if (lastHeading==null) lastHeading=rw.heading;
    const step=(rw.heading-lastHeading)*0.1;
    lastHeading+=step;

    // Couleur sonos (int√®gre F017 rouge si IS_TAKEOFF_04)
    colorSonoByRunway(rw.name);

    // Corridor + Heatmap (optionnel)
    const impacted=computeImpacted(lastHeading);
    updateHeatmap(impacted);

    document.getElementById("sonos-impacted").innerHTML =
      impacted.length
        ? impacted.map(s=>`<span class="tag impacted">${s.id}</span>`).join(" ")
        : "Aucun impact√©";

    computeAlerts(metar,rw);
  }

  // ADS-B apr√®s tout (met √† jour IS_TAKEOFF_04, VR, ic√¥ne, etc.)
  const adsb = await fetchADSB();
  updateADSB(adsb);

  // Ic√¥ne F017 en dernier (s√©curit√©)
  updateF017Icon();
}

let corridorLayer=null, heatLayer=null;

// D√©marrage
refresh();
setInterval(refresh,60_000);
</script>

</body>
</html>







