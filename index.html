<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>EBLG – FIDS, METAR, Bruit (Diapason), ADS‑B & Sonomètres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin:0; font-family:system-ui; display:flex; flex-direction:column; height:100vh; }
    header { background:#111827; color:#f9fafb; padding:0.5rem 1rem; display:flex; justify-content:space-between; }
    main { display:grid; grid-template-columns:320px 1fr; flex:1; }
    #sidebar { padding:1rem; overflow-y:auto; border-right:1px solid #ddd; font-size:0.85rem; }
    #map { width:100%; height:100%; }
    .block { margin-bottom:1rem; border-bottom:1px solid #ddd; padding-bottom:1rem; }
    .metar { background:#C7C7D1; padding:0.4rem; border-radius:4px; font-family:monospace; }
    .small { font-size:1rem; color:#555; }
    .tag { background:#eee; padding:2px 6px; border-radius:4px; font-size:0.7rem; }
    .tag.impacted { background:#1CB939; color:#FFFFFF; }
    .flight-row { padding:3px 0; cursor:pointer; }
    .flight-row:hover { background:#f3f4f6; }
    button.tag { cursor:pointer; border:none; background:#e5e7eb; padding:3px 8px; border-radius:4px; margin-right:4px; }
    button.tag:hover { background:#d1d5db; }
    @media(max-width:768px){
      main{display:flex; flex-direction:column;}
      #sidebar{border-right:none; border-bottom:1px solid #ddd; max-height:45vh;}
      #map{height:55vh;}
    }
  </style>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
</head>

<body>
<header>
  <h1>EBLG – FIDS + METAR + Bruit (Diapason) + ADS‑B</h1>
  <div class="small">Interface consolidée</div>
</header>

<div id="controls" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
  <button id="toggle-heatmap" class="tag">Heatmap : ON</button>
  <button id="toggle-corridor" class="tag">Corridor : ON</button>
  <button id="toggle-tracks" class="tag">Trajectoires ADS‑B : ON</button>
  <button id="toggle-sonos" class="tag">Sonomètres : ON</button>
  <button id="reset-map" class="tag">Reset Carte</button>
</div>

<main>
  <section id="sidebar">
    <div class="block">
      <h2>Météo EBLG</h2>
      <div id="meteo-summary" class="small">Chargement...</div>
      <div id="meteo-raw" class="metar"></div>
    </div>

    <div class="block">
      <h2>Piste & couloir bruit</h2>
      <div id="runway-info" class="small">Analyse...</div>
    </div>

    <div class="block">
      <h2>Sonomètres impactés</h2>
      <div id="sonos-impacted" class="small">En attente...</div>
    </div>

    <div class="block">
      <h2>Bruit en temps réel (Diapason)</h2>
      <div id="noise-live" class="small">Connexion...</div>
    </div>

    <div class="block">
      <h2>Alertes</h2>
      <div id="alerts" class="small">Aucune alerte.</div>
    </div>

    <div class="block">
      <h2>Vols (FIDS)</h2>
      <div>
        <button class="tag" onclick="setFilter('ALL')">ALL</button>
        <button class="tag" onclick="setFilter('ARR')">ARR</button>
        <button class="tag" onclick="setFilter('DEP')">DEP</button>
      </div>
      <div id="flights-list" class="small">Chargement...</div>
    </div>

    <div class="block">
      <h2>Détail du vol</h2>
      <div id="flight-detail" class="small">Sélectionnez un vol…</div>
    </div>
  </section>

  <section id="map"></section>
</main>

<script>
/* ============================================================
   CONFIG
============================================================ */
const AVWX_TOKEN="ersegQzkf2Dfal-o26B4b5uzMrXBeHK2jOpOaY7nffc";
const PROXY="https://eblg-proxy.onrender.com/fids?url=";
const URL_ARR=PROXY+encodeURIComponent("https://fids.liegeairport.com/api/flights/Arrivals");
const URL_DEP=PROXY+encodeURIComponent("https://fids.liegeairport.com/api/flights/Departures");

const EBLG={lat:50.6374,lon:5.4432,runways:[{name:"04",heading:40},{name:"22",heading:220}]};

let FLT_FILTER="ALL", lastHeading=null, lastRunway=null;
let ADSB_BY_CALLSIGN={}, LAST_FIDS=null;

/* ============================================================
   SONOMÈTRES
============================================================ */
const SONOS=[
  {id:"F017",lat:50.764883,lon:5.630606,addr:"Rue de la Pommeraie, 4690 Wonck"},
  {id:"F001",lat:50.738044,lon:5.608833,addr:"Rue Franquet, Houtain"},
  {id:"F014",lat:50.718894,lon:5.573164,addr:"Rue Léon Labaye, Juprelle"},
  {id:"F015",lat:50.688839,lon:5.526217,addr:"Rue du Brouck, Juprelle"},
  {id:"F005",lat:50.639331,lon:5.323519,addr:"Rue Caquin, Haneffe"},
  {id:"F003",lat:50.601167,lon:5.3814,addr:"Rue Fond Méan, St Georges"},
  {id:"F011",lat:50.601142,lon:5.356006,addr:"Rue Albert 1er, St Georges"},
  {id:"F008",lat:50.594878,lon:5.35895,addr:"Rue Warfusée, St Georges"},
  {id:"F002",lat:50.588414,lon:5.370522,addr:"Rue Noiset, St Georges"},
  {id:"F007",lat:50.590756,lon:5.345225,addr:"Rue Yernawe, St Georges"},
  {id:"F009",lat:50.580831,lon:5.355417,addr:"Bibliothèque, Place Verte, Stockay"},
  {id:"F004",lat:50.605414,lon:5.321406,addr:"Vinâve des Stréats, Verlaine"},
  {id:"F010",lat:50.599392,lon:5.313492,addr:"Rue Haute Voie, Verlaine"},
  {id:"F013",lat:50.586914,lon:5.308678,addr:"Rue Bois Léon, Verlaine"},
  {id:"F016",lat:50.619617,lon:5.295344,addr:"Rue de Chapon-Seraing, Verlaine"},
  {id:"F006",lat:50.609594,lon:5.271403,addr:"Rue Bolly Chapon, Seraing"},
  {id:"F012",lat:50.621917,lon:5.254747,addr:"Rue Barbe d'Or, Aineffe"}
];

/* ============================================================
   MATRICE OFFICIELLE SONO_RULES
============================================================ */
const SONO_RULES = {
  "22": {
    "DEP": ["F002","F003","F004","F005","F006","F007","F008","F009","F010","F011","F012","F013","F016"],
    "ARR": ["F001","F014","F015","F017"]
  },
  "04": {
    "ARR_GREEN": ["F002","F003","F007","F008","F009","F011","F013"],
    "ARR_RED":   ["F004","F005","F006","F010","F012","F016"],
    "DEP_GREEN": ["F014","F015"],
    "DEP_RED":   ["F001","F017"]
  }
};

const COLOR={green:"#10b981",red:"#ef4444",gray:"#6b7280"};

/* ============================================================
   MAP + SONO MARKERS
============================================================ */
const map=L.map("map").setView([EBLG.lat,EBLG.lon],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

L.circleMarker([EBLG.lat,EBLG.lon],{radius:7,color:"#FFFFFF",fillColor:"#2563eb",fillOpacity:1})
  .addTo(map).bindPopup("EBLG – Liège Airport");

const SONO_MARKERS=SONOS.map(s=>{
  const m=L.circleMarker([s.lat,s.lon],{
    radius:5,color:COLOR.gray,fillColor:COLOR.gray,fillOpacity:1
  }).addTo(map)
    .bindPopup(`<strong>${s.id}</strong><br>${s.addr}<br><span id="lv_${s.id}">niveau: … dB(A)</span><br><br><canvas id="chart_${s.id}" width="250" height="120"></canvas>`);
  return {...s,marker:m};
});

/* ============================================================
   OUTILS GÉO
============================================================ */
function toRad(d){return d*Math.PI/180}
function toDeg(r){return 180*r/Math.PI}

function computePoint([lat,lon],hd,km){
  const R=6371,d=km/R,h=toRad(hd),la=toRad(lat),lo=toRad(lon);
  const la2=Math.asin(Math.sin(la)*Math.cos(d)+Math.cos(la)*Math.sin(d)*Math.cos(h));
  const lo2=lo+Math.atan2(Math.sin(h)*Math.sin(d)*Math.cos(la),Math.cos(d)-Math.sin(la)*Math.sin(la2));
  return[toDeg(la2),toDeg(lo2)];
}

function distanceKm(a,b,c,d){
  const R=6371,dl=toRad(c-a),dn=toRad(d-b);
  const h=Math.sin(dl/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dn/2)**2;
  return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}

function distancePointToSegmentKm(p,A,B){
  const kx=111*Math.cos(toRad((A[0]+B[0])/2)),ky=111;
  const px=(p[1]-A[1])*kx,py=(p[0]-A[0])*ky;
  const bx=(B[1]-A[1])*kx,by=(B[0]-A[0])*ky;
  const t=Math.max(0,Math.min(1,(px*bx+py*by)/(bx*bx+by*by||1)));
  const qx=t*bx,qy=t*by;
  return Math.sqrt((px-qx)**2+(py-qy)**2);
}

function pointInPolygon([x,y],poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const[xi,yi]=poly[i],[xj,yj]=poly[j];
    const inter=yi>y!=yj>y&&x<(xj-xi)*(y-yi)/(yj-yi+1e-12)+xi;
    if(inter)inside=!inside;
  }
  return inside;
}

/* ============================================================
   RUNWAYS
============================================================ */
const RWY04_START=[50.63795,5.4438],RWY04_END=[50.6436,5.452],RWY04_HEADING=40;
const RWY22_START=RWY04_END,RWY22_END=RWY04_START,RWY22_HEADING=220;

const RWY04_POLY=[
 computePoint(RWY04_START,RWY04_HEADING-90,0.03),
 computePoint(RWY04_END,RWY04_HEADING-90,0.03),
 computePoint(RWY04_END,RWY04_HEADING+90,0.03),
 computePoint(RWY04_START,RWY04_HEADING+90,0.03)];

const RWY22_POLY=[
 computePoint(RWY22_START,RWY22_HEADING-90,0.03),
 computePoint(RWY22_END,RWY22_HEADING-90,0.03),
 computePoint(RWY22_END,RWY22_HEADING+90,0.03),
 computePoint(RWY22_START,RWY22_HEADING+90,0.03)];

function buildExtendedCenterlinePoly(start,hd,w,l){
  const end=computePoint(start,hd,l);
  return[
    computePoint(start,hd-90,w),
    computePoint(end,hd-90,w),
    computePoint(end,hd+90,w),
    computePoint(start,hd+90,w)];
}

const RWY04_EXT_POLY=buildExtendedCenterlinePoly(RWY04_END,RWY04_HEADING,0.5,6);
const RWY22_EXT_POLY=buildExtendedCenterlinePoly(RWY22_END,RWY22_HEADING,0.5,6);

/* ============================================================
   TOGGLES
============================================================ */
let HEATMAP_ENABLED=true,CORRIDOR_ENABLED=true,TRACKS_ENABLED=true,SONOS_ENABLED=true;
let corridorLayer=null,heatLayer=null;

/* ============================================================
   ICÔNES AVION
============================================================ */
const HEAD_TOL=15;
  
const AIRCRAFT_ICON = (track, color) => L.divIcon({
  html: `
    <svg width="32" height="32" viewBox="0 0 24 24"
         style="transform: rotate(${track}deg);">
      <path fill="${color}" d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z"/>
    </svg>
  `,
  className: "aircraft-icon",
  iconSize: [32, 32],
  iconAnchor: [16, 16]
});

const PLANE_DEP=t=>L.divIcon({
  html:`<svg width="28" height="28" viewBox="0 0 24 24" style="transform:rotate(${t}deg)"><path fill="#f97316" d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z"/></svg>`,
  className:"plane-icon",iconSize:[28,28],iconAnchor:[14,14]
});

const PLANE_ARR=t=>L.divIcon({
  html:`<svg width="28" height="28" viewBox="0 0 24 24" style="transform:rotate(${t}deg)"><path fill="#2563eb" d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z"/></svg>`,
  className:"plane-icon",iconSize:[28,28],iconAnchor:[14,14]
});

/* ============================================================
   LÉGENDE
============================================================ */
(function(){
  const c=map.getContainer(),box=document.createElement("div");
  box.id="legend";
  box.style="position:absolute;bottom:20px;left:20px;background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.25);font-size:13px;z-index:9999;min-width:220px";
  box.innerHTML=
  '<div style="font-weight:600;margin-bottom:6px">Légende</div>'+
  '<div style="display:flex;align-items:center;gap:6px;margin:4px 0">'+
    '<svg width="22" height="22" viewBox="0 0 24 24" style="transform:rotate(40deg)"><path fill="#f97316" d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z"/></svg>'+
    '<span>Avion (départ)</span></div>'+
  '<div style="display:flex;align-items:center;gap:6px;margin:4px 0">'+
    '<svg width="22" height="22" viewBox="0 0 24 24" style="transform:rotate(220deg)"><path fill="#2563eb" d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z"/></svg>'+
    '<span>Avion (arrivée)</span></div>'+
  '<div style="display:flex;align-items:center;gap:8px;margin:4px 0">'+
    '<span style="width:12px;height:12px;border-radius:50%;display:inline-block;background:#6b7280"></span><span>Sonomètre (normal)</span></div>'+
  '<div style="display:flex;align-items:center;gap:8px;margin:4px 0">'+
    '<span style="width:12px;height:12px;border-radius:50%;display:inline-block;background:#ef4444"></span><span>Sonomètre rouge</span></div>'+
  '<div style="display:flex;align-items:center;gap:8px;margin:4px 0">'+
    '<span style="width:12px;height:12px;border-radius:50%;display:inline-block;background:#10b981"></span><span>Sonomètre vert</span></div>'+
  '<div style="display:flex;align-items:center;gap:8px;margin:4px 0">'+
    '<span style="width:20px;height:10px;border:2px solid #f97316;background:rgba(249,115,22,.15);display:inline-block"></span><span>Couloir bruit</span></div>'+
  '<div style="display:flex;align-items:center;gap:8px;margin:4px 0">'+
    '<span style="font-size:18px">✈️⬆️</span><span>F017 pendant décollage</span></div>'+
  '<div style="display:flex;align-items:center;gap:8px;margin:4px 0">'+
    '<span style="width:24px;height:2px;background:#fbbf24;display:inline-block"></span><span>Trajectoire ADS‑B</span></div>'+
  '<hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0">'+
  '<div style="display:flex;align-items:center;gap:8px;justify-content:space-between">'+
    '<div style="display:flex;align-items:center;gap:6px"><span id="dia-led" style="width:10px;height:10px;border-radius:50%;background:#ef4444;display:inline-block"></span><span id="dia-text">Diapason : déconnecté</span></div>'+
    '<button id="dia-reconnect" style="padding:4px 8px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;cursor:pointer">Reconnecter</button>'+
  '</div>';
  c.appendChild(box);
})();

/* ============================================================
   LOGIQUE ICÔNE AVION
============================================================ */
function normalizeCallsign(t){
  return t?String(t).toUpperCase().trim().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"").slice(0,8):"";
}

function planeIconFor(callsign, track) {
  const n = normalizeCallsign(callsign || "");
  let kind = null;

  if (LAST_FIDS) {
    const arr = (LAST_FIDS.arrivals || []).find(v => normalizeCallsign(v.flightPax || v.flight || v.callsign) === n);
    const dep = (LAST_FIDS.departures || []).find(v => normalizeCallsign(v.flightPax || v.flight || v.callsign) === n);
    if (dep) kind = "DEP";
    else if (arr) kind = "ARR";
  }

  if (!kind) {
    if (track != null) {
      const d04 = Math.min(Math.abs(track - 40), 360 - Math.abs(track - 40));
      const d22 = Math.min(Math.abs(track - 220), 360 - Math.abs(track - 220));
      kind = (d04 <= HEAD_TOL || d22 <= HEAD_TOL) ? "DEP" : "ARR";
    } else {
      kind = "ARR";
    }
  }

  const color = kind === "DEP" ? "#f97316" : "#2563eb";
  return AIRCRAFT_ICON(track || 0, color);
}


/* ============================================================
   ADS‑B
============================================================ */
let ADSB_MARKERS={},ADSB_TRACKS={};

async function fetchADSB(){
  const u="https://opensky-network.org/api/states/all?lamin=50.3&lomin=5.1&lamax=50.9&lomax=5.8";
  try{const r=await fetch(u);const j=await r.json();return j.states||[]}catch(e){return[]}
}

function updateADSB(states){
  states.forEach(s=>{
    const icao=s[0], cs=(s[1]||"").trim(), lon=s[5], lat=s[6], track=s[10]||0;
    if(lat==null||lon==null) return;

    if(!ADSB_MARKERS[icao]){
      ADSB_MARKERS[icao]=L.marker([lat,lon],{icon:planeIconFor(cs,track)})
        .addTo(map)
        .bindPopup(`ICAO: ${icao}<br>Callsign: ${cs}`);
    }else{
      ADSB_MARKERS[icao].setLatLng([lat,lon]);
      ADSB_MARKERS[icao].setIcon(planeIconFor(cs,track));
    }

    if(!ADSB_TRACKS[icao]) ADSB_TRACKS[icao]=[];
    ADSB_TRACKS[icao].push([lat,lon]);
    if(ADSB_TRACKS[icao].length>40) ADSB_TRACKS[icao].shift();

    if(ADSB_TRACKS[icao].poly){
      map.removeLayer(ADSB_TRACKS[icao].poly);
      ADSB_TRACKS[icao].poly=null;
    }

    if(TRACKS_ENABLED){
      ADSB_TRACKS[icao].poly=L.polyline(ADSB_TRACKS[icao],{color:"#fbbf24",weight:2}).addTo(map);
    }

    const norm=normalizeCallsign(cs);
    if(norm){
      ADSB_BY_CALLSIGN[norm]={icao,marker:ADSB_MARKERS[icao]};
      ADSB_MARKERS[icao].off("click");
      ADSB_MARKERS[icao].on("click",()=>{
        if(!LAST_FIDS) return;
        const all=[...(LAST_FIDS.arrivals||[]),...(LAST_FIDS.departures||[])];
        const match=all.find(v=>normalizeCallsign(v.flightPax||v.flight||v.callsign)===norm);
        if(match) showFlightDetail(match);
      });
    }
  });

  detectTakeoff04(states);
  detectTakeoff22(states);
  updateF017Icon();
  annotateFlightsWithADSB();
}

function hideAllTracks(){
  Object.values(ADSB_TRACKS).forEach(t=>{
    if(t.poly){map.removeLayer(t.poly);t.poly=null}
  });
}

function annotateFlightsWithADSB(){
  try{
    const el=document.getElementById("flights-list"); if(!el) return;
    el.querySelectorAll(".flight-row").forEach(row=>{
      const norm=row.getAttribute("data-normcallsign");
      const badge=row.querySelector(".adsb-badge");
      const ok=norm && !!ADSB_BY_CALLSIGN[norm];
      if(badge){
        badge.textContent=ok?"ADS‑B OK":"—";
        badge.style.background=ok?"#10b981":"#d1d5db";
        badge.style.color=ok?"#fff":"#111";
      }
    });
  }catch(e){}
}

function focusAircraftByCallsign(norm,v){
  const hit=norm?ADSB_BY_CALLSIGN[norm]:null;

  if(hit&&hit.marker){
    const mk=hit.marker,ll=mk.getLatLng();
    map.setView(ll,13); mk.openPopup();
    const ping=L.circle(ll,{radius:150,color:"#22c55e",weight:2,fillOpacity:.1});
    ping.addTo(map); setTimeout(()=>map.removeLayer(ping),2500);
  }else{
    highlightFlightOnMap(v);
  }

  if(v && v.runway){
    const runway=v.runway.replace(/[^0-9]/g,"");
    const phase=v.direction==="Arrivals"?"ARR":"DEP";
    updateSonoColors(runway,phase);
  }
}

/* ============================================================
   METAR
============================================================ */
async function fetchMetar(){
  const u=`https://avwx.rest/api/metar/EBLG?token=${AVWX_TOKEN}&format=json`;
  const r=await fetch(u);
  return r.json();
}

function updateMetarUI(m){
  try{
    document.getElementById("meteo-summary").textContent=
      `Vent ${m.wind_direction.value}° / ${m.wind_speed.value} kt – T° ${m.temperature.value}°C`;
    document.getElementById("meteo-raw").textContent=m.raw;
  }catch(e){}
}

function formatLocal(t){
  return t?new Date(t).toLocaleTimeString("fr-BE",{hour:"2-digit",minute:"2-digit",hour12:false}):"-";
}

/* ============================================================
   FIDS
============================================================ */
async function fetchFIDS(){
  const arr=await fetch(URL_ARR).then(r=>r.json()).catch(()=>[]);
  const dep=await fetch(URL_DEP).then(r=>r.json()).catch(()=>[]);
  return {arrivals:Array.isArray(arr)?arr:[],departures:Array.isArray(dep)?dep:[]};
}

function setFilter(f){FLT_FILTER=f;refresh()}

function updateFlightsUI(f){
  LAST_FIDS=f;
  const el=document.getElementById("flights-list");
  let all=[...f.arrivals,...f.departures];

  if(FLT_FILTER==="ARR") all=all.filter(v=>v.direction==="Arrivals");
  if(FLT_FILTER==="DEP") all=all.filter(v=>v.direction==="Departures");

  all.sort((a,b)=>new Date(a.sTx)-new Date(b.sTx));
  all=all.slice(0,10);

  if(!all.length){el.textContent="Aucun vol.";return}

  el.innerHTML=all.map(v=>{
    const raw=v.flightPax||v.flight||v.callsign||"", norm=normalizeCallsign(raw);
    const has=norm && !!ADSB_BY_CALLSIGN[norm];
    const rwy=v.runway||"?";

    return `<div class="flight-row" data-id="${v.id}" data-normcallsign="${norm}">
      ${v.direction==="Arrivals"?"ARR":"DEP"} ${raw} (${v.aircraftType}) – RWY ${rwy}
      <span class="tag adsb-badge" style="margin-left:6px;${has?'background:#10b981;color:#fff;':''}">
        ${has?'ADS‑B OK':'—'}
      </span><br>
      ${formatLocal(v.sTx)} → ${formatLocal(v.eTx)}
    </div>`;
  }).join("");

  el.querySelectorAll(".flight-row").forEach(row=>{
    row.onclick=()=>{
      const id=row.getAttribute("data-id"), norm=row.getAttribute("data-normcallsign");
      const v=all.find(x=>x.id===id);
      if(v) showFlightDetail(v);
      focusAircraftByCallsign(norm,v);
    };
  });

  annotateFlightsWithADSB();
}

function showFlightDetail(v){
  document.getElementById("flight-detail").innerHTML=
  `<strong>${v.flightPax}</strong> – ${v.aircraftType}<br>
   ${v.origin} → ${v.destination}<br>
   Piste : ${v.runway||"-"}<br>
   STD/STA : ${formatLocal(v.sTx)}<br>
   ETD/ETA : ${formatLocal(v.eTx)}<br>
   ATD/ATA : ${formatLocal(v.aTx)}<br>
   Stand : ${v.stand||"-"}<br>
   Opérateur : ${v.operator||"-"}`;
}

function highlightFlightOnMap(v){
  if(!v) return;
  const pos=[EBLG.lat+0.005,EBLG.lon+0.005];
  if(window.flightMarker) map.removeLayer(window.flightMarker);
  window.flightMarker=L.circleMarker(pos,{radius:10,color:"#f97316",fillColor:"#f97316",fillOpacity:.9})
    .addTo(map).bindPopup(`Vol ${v.flightPax}`);
  map.setView(pos,13);
}

/* ============================================================
   RUNWAY / COULOIR / HEATMAP / SONO COLORS
============================================================ */
function extractRunway(f){
  const all=[...f.arrivals,...f.departures];
  const r=all.find(v=>v.runway);
  if(!r) return null;
  const name=r.runway.replace(/[^0-9]/g,"");
  return EBLG.runways.find(x=>x.name===name)||null;
}

function runwayFromMetar(m){
  if(!m||!m.wind_direction||m.wind_direction.value==null) return null;
  const wd=m.wind_direction.value;
  let best=null,bestDiff=999;

  EBLG.runways.forEach(rw=>{
    const d=Math.min(Math.abs(wd-rw.heading),360-Math.abs(wd-rw.heading));
    if(d<bestDiff){bestDiff=d;best=rw}
  });

  return best;
}

function buildCorridor(h){
  const start=[EBLG.lat,EBLG.lon], end=computePoint(start,h,20);
  const lS=computePoint(start,h-90,1.5), rS=computePoint(start,h+90,1.5);
  const lE=computePoint(end,h-90,3.5), rE=computePoint(end,h+90,3.5);
  return [lS,lE,rE,rS];
}

/* ============================================================
   COLORATION SONOMÈTRES (MATRICE OFFICIELLE)
============================================================ */
function updateSonoColors(runway, phase) {
  SONO_MARKERS.forEach(s => {
    let color = COLOR.gray;

    if (runway === "22") {
      if (SONO_RULES["22"][phase].includes(s.id)) {
        color = COLOR.green;
      }
    }

    if (runway === "04") {
      if (phase === "ARR") {
        if (SONO_RULES["04"].ARR_GREEN.includes(s.id)) color = COLOR.green;
        if (SONO_RULES["04"].ARR_RED.includes(s.id))   color = COLOR.red;
      }
      if (phase === "DEP") {
        if (SONO_RULES["04"].DEP_GREEN.includes(s.id)) color = COLOR.green;
        if (SONO_RULES["04"].DEP_RED.includes(s.id))   color = COLOR.red;
      }
    }

    s.marker.setStyle({ color, fillColor: color, fillOpacity: 1 });
  });
}

/* ============================================================
   HEATMAP (basée sur computeImpacted)
============================================================ */
function computeImpacted(h){
  const poly=h<180?RWY04_EXT_POLY:RWY22_EXT_POLY;
  return SONO_MARKERS.filter(s=>pointInPolygon([s.lat,s.lon],poly));
}

function updateHeatmap(list){
  if(heatLayer){map.removeLayer(heatLayer);heatLayer=null}
  if(!HEATMAP_ENABLED) return;
  if(!list||!list.length) return;
  heatLayer=L.heatLayer(list.map(s=>[s.lat,s.lon,0.7]),{radius:35,blur:25}).addTo(map);
}

/* ============================================================
   DIAPASON – SignalR + LED
============================================================ */
const HUB_URL="https://eblg.aerovision.cloud/EBLG/signalr-noise";
const SENSOR_MAP={
  1:"F001",2:"F002",3:"F003",4:"F004",5:"F005",6:"F006",7:"F007",8:"F008",9:"F009",
  10:"F010",11:"F011",12:"F012",13:"F013",14:"F014",15:"F015",16:"F016",17:"F017"
};

let LIVE_NOISE={}, HISTORY_DURATION_MS=5*60*1000, NOISE_HISTORY={};
SONOS.forEach(s=>NOISE_HISTORY[s.id]=[]);
let CHARTS={};

const connection=new signalR.HubConnectionBuilder()
  .withUrl(HUB_URL)
  .withAutomaticReconnect()
  .build();

function setDiaLED(ok){
  const led=document.getElementById("dia-led");
  const lbl=document.getElementById("dia-text");
  if(led) led.style.background = ok ? "#10b981" : "#ef4444";
  if(lbl) lbl.textContent = ok ? "Diapason : connecté" : "Diapason : déconnecté";
}

async function startDiapason(){
  try{
    await connection.start();
    setDiaLED(true);
  }catch(e){
    setDiaLED(false);
  }
}

connection.onreconnected(()=>setDiaLED(true));
connection.onclose(()=>setDiaLED(false));

connection.on("addNoiseMeasure",(sensorId,payload)=>{
  const fId=SENSOR_MAP[sensorId] || `ID_${sensorId}`;

  LIVE_NOISE[fId]={ laeq:payload.value, t:new Date(payload.timeStamp).toISOString() };

  const now=Date.now();
  NOISE_HISTORY[fId].push({t:now,v:payload.value});
  NOISE_HISTORY[fId]=NOISE_HISTORY[fId].filter(p=>now-p.t<=HISTORY_DURATION_MS);

  updateHistoryChart(fId);
  updateNoiseUI(Object.entries(LIVE_NOISE).map(([id,v])=>({id,laeq:v.laeq,t:v.t})));

  const span=document.getElementById(`lv_${fId}`);
  if(span) span.textContent=`niveau: ${payload.value} dB(A)`;
});

function updateNoiseUI(list){
  const box=document.getElementById("noise-live");
  if(!box) return;
  if(!list || !list.length){
    box.textContent="Aucune donnée.";
    return;
  }
  box.innerHTML=list
    .sort((a,b)=>a.id>b.id?1:-1)
    .map(v=>`<div><strong>${v.id}</strong> : ${v.laeq??"n/d"} dB(A)</div>`)
    .join("");
}

function updateHistoryChart(fId){
  const canvas=document.getElementById(`chart_${fId}`);
  if(!canvas) return;

  const data=NOISE_HISTORY[fId];
  const labels=data.map(p=>new Date(p.t).toLocaleTimeString("fr-BE",{minute:"2-digit",second:"2-digit"}));
  const values=data.map(p=>p.v);

  if(!CHARTS[fId]){
    CHARTS[fId]=new Chart(canvas.getContext("2d"),{
      type:"line",
      data:{
        labels,
        datasets:[{
          label:"LAeq (dB)",
          data:values,
          borderColor:"#2563eb",
          backgroundColor:"rgba(37,99,235,0.2)",
          tension:.25,
          borderWidth:2,
          pointRadius:0
        }]
      },
      options:{
        animation:false,
        scales:{ x:{display:true}, y:{min:20,max:90} },
        plugins:{ legend:{display:false} }
      }
    });
  }else{
    CHARTS[fId].data.labels=labels;
    CHARTS[fId].data.datasets[0].data=values;
    CHARTS[fId].update();
  }
}

/* ============================================================
   ALERTES METEO
============================================================ */
function computeAlerts(m,rw){
  const a=[];
  if(m?.wind_speed?.value > 25) a.push("Vent fort (>25 kt)");
  if(m?.wind_gust?.value > 35) a.push("Rafales (>35 kt)");

  if(rw && m?.wind_direction){
    const diff=Math.abs(m.wind_direction.value - rw.heading);
    if(diff>150 && diff<210) a.push("Vent arrière");
  }

  if(lastRunway && rw && lastRunway !== rw.name)
    a.push(`Changement piste : ${lastRunway} → ${rw.name}`);

  lastRunway = rw ? rw.name : null;

  const el=document.getElementById("alerts");
  if(el) el.innerHTML = a.length
    ? a.map(x=>`<div>⚠️ ${x}</div>`).join("")
    : "Aucune alerte.";
}

/* ============================================================
   DÉTECTION DÉCOLLAGES 04 & 22 + VR + F017
============================================================ */
const MS2KT=1.943844, M2FT=3.28084, HEADING_TOL=HEAD_TOL;
const ROLL_GS_KT=70, VR_GS_KT=110, CLIMB_MAX_ALT_FT=200, CENTERLINE_MAX_OFFSET_KM=0.5;

let IS_TAKEOFF_04=false, lastTakeoffTime04=0;
let IS_TAKEOFF_22=false, lastTakeoffTime22=0;
let VR_DETECTED=false, VR_LOCATION=null, VR_MARKER=null;

const TAKEOFF_ICON=L.divIcon({
  html:"✈️⬆️",
  className:"takeoff-icon",
  iconSize:[30,30],
  iconAnchor:[15,15]
});

(function(){
  const st=document.createElement("style");
  st.textContent=".takeoff-icon{font-size:28px;color:#dc2626;text-shadow:0 0 4px rgba(0,0,0,.6);}";
  document.head.appendChild(st);
})();

let f017MarkerAbove=null;

function showToast(msg,bg="#dc2626"){
  const m=document.createElement("div");
  m.style.position="fixed";
  m.style.top="20px";
  m.style.right="20px";
  m.style.background=bg;
  m.style.color="#fff";
  m.style.padding="12px 18px";
  m.style.borderRadius="6px";
  m.style.fontSize="16px";
  m.style.boxShadow="0 4px 10px rgba(0,0,0,.3)";
  m.style.zIndex=99999;
  m.style.opacity="0";
  m.style.transition="opacity .2s";
  m.textContent=msg;
  document.body.appendChild(m);
  requestAnimationFrame(()=>{m.style.opacity="1"});
  setTimeout(()=>{m.style.opacity="0"; setTimeout(()=>m.remove(),600)},3500);
}

function showTakeoffNotification04(cs){
  showToast(`Décollage RWY 04 détecté : ${cs}`,"#dc2626");
}

function updateF017Icon(){
  const s=SONOS.find(x=>x.id==="F017");
  if(!s) return;

  if(IS_TAKEOFF_04){
    if(!f017MarkerAbove)
      f017MarkerAbove=L.marker([s.lat,s.lon],{icon:TAKEOFF_ICON}).addTo(map);
  }else{
    if(f017MarkerAbove){
      map.removeLayer(f017MarkerAbove);
      f017MarkerAbove=null;
    }
  }
}

function distanceKmWrap(lat,lon){
  const f=SONOS.find(s=>s.id==="F017");
  return distanceKm(lat,lon,f.lat,f.lon);
}

let F017_SURVEY_START=null, F017_SURVEY_ACTIVE=false;

function checkF017Overflight(lat,lon){
  const dist=distanceKmWrap(lat,lon);

  if(!IS_TAKEOFF_04){
    if(F017_SURVEY_ACTIVE && F017_SURVEY_START){
      const d=((Date.now()-F017_SURVEY_START)/1e3).toFixed(1);
      showToast(`Survol F017 terminé – durée ${d} s`,"#0ea5e9");
    }
    F017_SURVEY_ACTIVE=false;
    F017_SURVEY_START=null;
    return;
  }

  if(dist<0.5){
    if(!F017_SURVEY_ACTIVE){
      F017_SURVEY_ACTIVE=true;
      F017_SURVEY_START=Date.now();
    }
  }else{
    if(F017_SURVEY_ACTIVE && F017_SURVEY_START){
      const d=((Date.now()-F017_SURVEY_START)/1e3).toFixed(1);
      showToast(`Survol F017 terminé – durée ${d} s`,"#0ea5e9");
    }
    F017_SURVEY_ACTIVE=false;
    F017_SURVEY_START=null;
  }
}

function angleDiff(a,b){
  let d=Math.abs(a-b)%360;
  if(d>180) d=360-d;
  return d;
}

function detectTakeoff04(states){
  let detected=false;

  for(const s of states){
    const cs=(s[1]||"").trim(), lon=s[5], lat=s[6];
    if(lat==null||lon==null) continue;

    const vel=s[9]||0, track=s[10]||null, vrate=s[11]||null;
    const alt_m=s[13]!=null?s[13]:(s[7]||0);
    const gs=vel*MS2KT, alt_ft=alt_m*M2FT;

    const norm=normalizeCallsign(cs);
    let fids=null;

    if(LAST_FIDS && LAST_FIDS.departures){
      fids=LAST_FIDS.departures.find(v=>
        normalizeCallsign(v.flightPax||v.flight||v.callsign)===norm &&
        (v.runway||"").includes("04")
      );
    }

    if(!fids) continue;

    const onRunway=pointInPolygon([lat,lon],RWY04_POLY);
    const good=track!=null ? (angleDiff(track,40)<=HEADING_TOL) : true;
    const offset=distancePointToSegmentKm([lat,lon],RWY04_START,RWY04_END);
    const near=offset<=CENTERLINE_MAX_OFFSET_KM;

    const roll=onRunway && good && gs>=ROLL_GS_KT;
    const climb=!onRunway && good && gs>=ROLL_GS_KT && (alt_ft>0 && alt_ft<=CLIMB_MAX_ALT_FT) && near;

    if(!VR_DETECTED && onRunway && good && gs>=VR_GS_KT && (alt_ft<50 || (vrate!=null && vrate>0.5))){
      VR_DETECTED=true;
      VR_LOCATION=[lat,lon];
      if(VR_MARKER) map.removeLayer(VR_MARKER);
      VR_MARKER=L.circleMarker(VR_LOCATION,{
        radius:8,color:"#22d3ee",fillColor:"#22d3ee",fillOpacity:.9
      }).addTo(map).bindPopup("Rotation Point (VR)");
    }

    if(roll || climb){
      detected=true;
      if(!IS_TAKEOFF_04) showTakeoffNotification04(cs||"—");
      IS_TAKEOFF_04=true;
      lastTakeoffTime04=Date.now();
      checkF017Overflight(lat,lon);
    }
  }

  if(!detected && IS_TAKEOFF_04 && (Date.now()-lastTakeoffTime04>20000)){
    IS_TAKEOFF_04=false;

    if(F017_SURVEY_ACTIVE && F017_SURVEY_START){
      const d=((Date.now()-F017_SURVEY_START)/1e3).toFixed(1);
      showToast(`Survol F017 terminé – durée ${d} s`,"#0ea5e9");
    }

    F017_SURVEY_ACTIVE=false;
    F017_SURVEY_START=null;
  }
}

function detectTakeoff22(states){
  let detected=false;

  for(const s of states){
    const cs=(s[1]||"").trim(), lon=s[5], lat=s[6];
    if(lat==null||lon==null) continue;

    const vel=s[9]||0, track=s[10]||null;
    const alt_m=s[13]!=null?s[13]:(s[7]||0);
    const gs=vel*MS2KT, alt_ft=alt_m*M2FT;

    const norm=normalizeCallsign(cs);
    let fids=null;

    if(LAST_FIDS && LAST_FIDS.departures){
      fids=LAST_FIDS.departures.find(v=>
        normalizeCallsign(v.flightPax||v.flight||v.callsign)===norm &&
        (v.runway||"").includes("22")
      );
    }

    if(!fids) continue;

    const onRunway=pointInPolygon([lat,lon],RWY22_POLY);
    const good=track!=null ? (angleDiff(track,220)<=HEADING_TOL) : true;
    const offset=distancePointToSegmentKm([lat,lon],RWY22_START,RWY22_END);
    const near=offset<=CENTERLINE_MAX_OFFSET_KM;

    const roll=onRunway && good && gs>=ROLL_GS_KT;
    const climb=!onRunway && good && gs>=ROLL_GS_KT && (alt_ft>0 && alt_ft<=CLIMB_MAX_ALT_FT) && near;

    if(roll || climb){
      detected=true;
      IS_TAKEOFF_22=true;
      lastTakeoffTime22=Date.now();
    }
  }

  if(!detected && IS_TAKEOFF_22 && (Date.now()-lastTakeoffTime22>20000)){
    IS_TAKEOFF_22=false;
  }
}

/* ============================================================
   DÉMARRAGE DIAPASON + BOUTON RECONNECT
============================================================ */
startDiapason();

(function(){
  const b=document.getElementById("dia-reconnect");
  if(!b) return;
  b.onclick=async()=>{
    setDiaLED(false);
    try{ await connection.stop().catch(()=>{});}catch(e){}
    await startDiapason();
  };
})();

/* ============================================================
   VISIBILITÉ SONOMÈTRES
============================================================ */
function updateSonometersVisibility(){
  SONO_MARKERS.forEach(s=>{
    if(SONOS_ENABLED){
      s.marker.addTo(map);
    }else{
      map.removeLayer(s.marker);
    }
  });
}

/* ============================================================
   TOGGLES UI + RESET
============================================================ */
(function(){
  const btnHeat=document.getElementById("toggle-heatmap");
  if(btnHeat){
    btnHeat.onclick=()=>{
      HEATMAP_ENABLED=!HEATMAP_ENABLED;
      btnHeat.textContent=`Heatmap : ${HEATMAP_ENABLED?"ON":"OFF"}`;
      if(!HEATMAP_ENABLED && heatLayer){ map.removeLayer(heatLayer); heatLayer=null; }
    };
  }

  const btnCorr=document.getElementById("toggle-corridor");
  if(btnCorr){
    btnCorr.onclick=()=>{
      CORRIDOR_ENABLED=!CORRIDOR_ENABLED;
      btnCorr.textContent=`Corridor : ${CORRIDOR_ENABLED?"ON":"OFF"}`;
      if(!CORRIDOR_ENABLED && corridorLayer){ map.removeLayer(corridorLayer); corridorLayer=null; }
    };
  }

  const btnTracks=document.getElementById("toggle-tracks");
  if(btnTracks){
    btnTracks.onclick=()=>{
      TRACKS_ENABLED=!TRACKS_ENABLED;
      btnTracks.textContent=`Trajectoires ADS‑B : ${TRACKS_ENABLED?"ON":"OFF"}`;
      if(!TRACKS_ENABLED) hideAllTracks();
    };
  }

  const btnSonos=document.getElementById("toggle-sonos");
  if(btnSonos){
    btnSonos.onclick=()=>{
      SONOS_ENABLED=!SONOS_ENABLED;
      btnSonos.textContent=`Sonomètres : ${SONOS_ENABLED?"ON":"OFF"}`;
      updateSonometersVisibility();
    };
  }

  function resetMap(){
    map.setView([EBLG.lat,EBLG.lon],11);
    map.closePopup();
    if(window.flightMarker){ map.removeLayer(window.flightMarker); window.flightMarker=null; }
    if(!HEATMAP_ENABLED && heatLayer){ map.removeLayer(heatLayer); heatLayer=null; }
    if(!CORRIDOR_ENABLED && corridorLayer){ map.removeLayer(corridorLayer); corridorLayer=null; }
    if(!TRACKS_ENABLED) hideAllTracks();
    updateSonometersVisibility();
  }

  const btnReset=document.getElementById("reset-map");
  if(btnReset) btnReset.onclick=()=>resetMap();
})();

/* ============================================================
   MAIN LOOP
============================================================ */
async function refresh(){
  const metar=await fetchMetar().catch(()=>null);
  if(metar) updateMetarUI(metar);

  const fids=await fetchFIDS().catch(()=>({arrivals:[],departures:[]}));
  updateFlightsUI(fids);

  const rwF=extractRunway(fids);
  const rwM=metar?runwayFromMetar(metar):null;
  const rw=rwF||rwM;

  if(!rw){
    const el=document.getElementById("runway-info");
    if(el) el.textContent="Piste indéterminée.";
  }else{
    const el=document.getElementById("runway-info");
    if(el) el.textContent=`Piste ${rw.name} – cap ${rw.heading}°`;

    if(lastHeading==null) lastHeading=rw.heading;
    lastHeading+=(rw.heading-lastHeading)*.1;

    // Corridor bruit (selon heading)
if (CORRIDOR_ENABLED) {
  const poly = buildCorridor(lastHeading);
  if (corridorLayer) map.removeLayer(corridorLayer);
  corridorLayer = L.polygon(poly, {
    color: "#f97316",
    weight: 2,
    fillColor: "rgba(249,115,22,0.15)",
    fillOpacity: 0.3
  }).addTo(map);
}

    updateSonoColors(rw.name,"ARR");

    const impacted=computeImpacted(lastHeading);
    updateHeatmap(impacted);

    const box=document.getElementById("sonos-impacted");
    if(box) box.innerHTML=impacted.length
      ? impacted.map(s=>`<span class="tag impacted">${s.id}</span>`).join(" ")
      : "Aucun impacté";

    computeAlerts(metar||{},rw);
    lastRunway=rw.name;
  }

  const adsb=await fetchADSB().catch(()=>[]);
  updateADSB(adsb);
  updateF017Icon();
}

refresh();
setInterval(refresh,60_000);
</script>

</body


