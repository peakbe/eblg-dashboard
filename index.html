<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>EBLG – FIDS, METAR, Bruit (Diapason), ADS‑B & Sonomètres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Styles -->
  <style>
    body { margin:0; font-family:system-ui; display:flex; flex-direction:column; height:100vh; }
    header { background:#111827; color:#f9fafb; padding:0.5rem 1rem; display:flex; justify-content:space-between; }
    main { display:grid; grid-template-columns:320px 1fr; flex:1; }
    #sidebar { padding:1rem; overflow-y:auto; border-right:1px solid #ddd; font-size:0.85rem; }
    #map { width:100%; height:100%; }
    .block { margin-bottom:1rem; border-bottom:1px solid #ddd; padding-bottom:1rem; }
    .metar { background:#C7C7D1; padding:0.4rem; border-radius:4px; font-family:monospace; }
    .small { font-size:0.75rem; color:#555; }
    .tag { background:#eee; padding:2px 6px; border-radius:4px; font-size:0.7rem; }
    .tag.impacted { background:#1CB939; color:#FFFFFF; }
    .flight-row { padding:3px 0; cursor:pointer; }
    .flight-row:hover { background:#f3f4f6; }
    button.tag { cursor:pointer; border:none; background:#e5e7eb; padding:3px 8px; border-radius:4px; margin-right:4px; }
    button.tag:hover { background:#d1d5db; }
    @media(max-width:768px){
      main{display:flex; flex-direction:column;}
      #sidebar{border-right:none; border-bottom:1px solid #ddd; max-height:45vh;}
      #map{height:55vh;}
    }
  </style>

  <!-- Leaflet JS + Heatmap -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SignalR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
</head>
<body>
<header>
  <h1>EBLG – FIDS + METAR + Bruit (Diapason) + ADS‑B</h1>
  <div class="small">Interface consolidée</div>
</header>

<div id="controls" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
  <button id="toggle-heatmap" class="tag">Heatmap : ON</button>
  <button id="toggle-corridor" class="tag">Corridor : ON</button>
  <button id="toggle-tracks" class="tag">Trajectoires ADS‑B : ON</button>
  <button id="toggle-sonos" class="tag">Sonomètres : ON</button>
  <button id="reset-map" class="tag">Reset Carte</button>
</div>
  
<main>
  <section id="sidebar">
    <div class="block">
      <h2>Météo EBLG</h2>
      <div id="meteo-summary" class="small">Chargement...</div>
      <div id="meteo-raw" class="metar"></div>
    </div>

    <div class="block">
      <h2>Piste & couloir bruit</h2>
      <div id="runway-info" class="small">Analyse...</div>
    </div>

    <div class="block">
      <h2>Sonomètres impactés</h2>
      <div id="sonos-impacted" class="small">En attente...</div>
    </div>

    <div class="block">
      <h2>Bruit en temps réel (Diapason)</h2>
      <div id="noise-live" class="small">Connexion...</div>
    </div>

    <div class="block">
      <h2>Alertes</h2>
      <div id="alerts" class="small">Aucune alerte.</div>
    </div>

    <div class="block">
      <h2>Vols (FIDS)</h2>
      <div>
        <button class="tag" onclick="setFilter('ALL')">ALL</button>
        <button class="tag" onclick="setFilter('ARR')">ARR</button>
        <button class="tag" onclick="setFilter('DEP')">DEP</button>
      </div>
      <div id="flights-list" class="small">Chargement...</div>
    </div>

    <div class="block">
      <h2>Détail du vol</h2>
      <div id="flight-detail" class="small">Sélectionnez un vol…</div>
    </div>
  </section>

  <section id="map"></section>
</main>
<script>
const AVWX_TOKEN="ersegQzkf2Dfal-o26B4b5uzMrXBeHK2jOpOaY7nffc",PROXY="https://eblg-proxy.onrender.com/fids?url=",URL_ARR=PROXY+encodeURIComponent("https://fids.liegeairport.com/api/flights/Arrivals"),URL_DEP=PROXY+encodeURIComponent("https://fids.liegeairport.com/api/flights/Departures"),EBLG={lat:50.6374,lon:5.4432,runways:[{name:"04",heading:40},{name:"22",heading:220}]};let FLT_FILTER="ALL",lastHeading=null,lastRunway=null;function normalizeCallsign(t){return t?String(t).toUpperCase().trim().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"").slice(0,8):""}let ADSB_BY_CALLSIGN={},LAST_FIDS=null;const SONOS=[{id:"F017",lat:50.764883,lon:5.630606,addr:"Rue de la Pommeraie, 4690 Wonck"},{id:"F001",lat:50.738044,lon:5.608833,addr:"Rue Franquet, Houtain"},{id:"F014",lat:50.718894,lon:5.573164,addr:"Rue Léon Labaye, Juprelle"},{id:"F015",lat:50.688839,lon:5.526217,addr:"Rue du Brouck, Juprelle"},{id:"F005",lat:50.639331,lon:5.323519,addr:"Rue Caquin, Haneffe"},{id:"F003",lat:50.601167,lon:5.3814,addr:"Rue Fond Méan, St Georges"},{id:"F011",lat:50.601142,lon:5.356006,addr:"Rue Albert 1er, St Georges"},{id:"F008",lat:50.594878,lon:5.35895,addr:"Rue Warfusée, St Georges"},{id:"F002",lat:50.588414,lon:5.370522,addr:"Rue Noiset, St Georges"},{id:"F007",lat:50.590756,lon:5.345225,addr:"Rue Yernawe, St Georges"},{id:"F009",lat:50.580831,lon:5.355417,addr:"Bibliothèque, Place Verte, Stockay"},{id:"F004",lat:50.605414,lon:5.321406,addr:"Vinâve des Stréats, Verlaine"},{id:"F010",lat:50.599392,lon:5.313492,addr:"Rue Haute Voie, Verlaine"},{id:"F013",lat:50.586914,lon:5.308678,addr:"Rue Bois Léon, Verlaine"},{id:"F016",lat:50.619617,lon:5.295344,addr:"Rue de Chapon-Seraing, Verlaine"},{id:"F006",lat:50.609594,lon:5.271403,addr:"Rue Bolly Chapon, Seraing"},{id:"F012",lat:50.621917,lon:5.254747,addr:"Rue Barbe d'Or, Aineffe"}],COLOR={green:"#10b981",red:"#ef4444",gray:"#6b7280"},RW22_TKOFF_GREEN=new Set(["F002","F003","F004","F005","F006","F007","F008","F009","F010","F011","F012","F013","F016"]),RW04_LDG_GREEN=new Set(["F002","F003","F007","F008","F009","F011","F013"]),RW04_BOTH_GREEN=new Set(["F001","F014","F015"]),RW04_LDG_IMP_RED=new Set(["F004","F005","F006","F010","F012","F016"]);const map=L.map("map").setView([EBLG.lat,EBLG.lon],11);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map),L.circleMarker([EBLG.lat,EBLG.lon],{radius:7,color:"#10b981",fillColor:"#10b981",fillOpacity:1}).addTo(map).bindPopup("EBLG – Liège Airport");const SONO_MARKERS=SONOS.map(t=>{const e=L.circleMarker([t.lat,t.lon],{radius:5,color:COLOR.gray,fillColor:COLOR.gray,fillOpacity:1}).addTo(map).bindPopup(`<strong>${t.id}</strong><br>${t.addr}<br><span id="lv_${t.id}">niveau: … dB(A)</span><br><br><canvas id="chart_${t.id}" width="250" height="120"></canvas>`);return{...t,marker:e}});function toRad(t){return t*Math.PI/180}function toDeg(t){return 180*t/Math.PI}function computePoint([t,e],o,a){const n=6371,i=a/n,r=toRad(o),l=toRad(t),s=toRad(e),d=Math.asin(Math.sin(l)*Math.cos(i)+Math.cos(l)*Math.sin(i)*Math.cos(r)),c=s+Math.atan2(Math.sin(r)*Math.sin(i)*Math.cos(l),Math.cos(i)-Math.sin(l)*Math.sin(d));return[toDeg(d),toDeg(c)]}function distanceKm(t,e,o,a){const n=6371,i=toRad(o-t),r=toRad(a-e),l=Math.sin(i/2)**2+Math.cos(toRad(t))*Math.cos(toRad(o))*Math.sin(r/2)**2;return 2*n*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))}function distancePointToSegmentKm(t,e,o){const a=111*Math.cos(toRad((e[0]+o[0])/2)),n=111,i=(t[1]-e[1])*a,r=(t[0]-e[0])*n,l=(o[1]-e[1])*a,s=(o[0]-e[0])*n,d=Math.max(0,Math.min(1,(i*l+r*s)/(l*l+s*s||1))),c=d*l,u=d*s,h=i-c,f=r-u;return Math.sqrt(h*h+f*f)}function pointInPolygon(t,e){const[o,a]=t;let n=!1;for(let t=0,i=e.length-1;t<e.length;i=t++){const r=e[t],l=e[i],s=r[0],d=r[1],c=l[0],u=l[1],h=d>a!=u>a&&o<(c-s)*(a-d)/(u-d+1e-12)+s;h&&(n=!n)}return n}const RWY04_START=[50.63795,5.4438],RWY04_END=[50.6436,5.452],RWY04_HEADING=40,RWY22_START=RWY04_END,RWY22_END=RWY04_START,RWY22_HEADING=220,RWY_HALF_WIDTH_KM=.03,RWY04_POLY=[computePoint(RWY04_START,RWY04_HEADING-90,RWY_HALF_WIDTH_KM),computePoint(RWY04_END,RWY04_HEADING-90,RWY_HALF_WIDTH_KM),computePoint(RWY04_END,RWY04_HEADING+90,RWY_HALF_WIDTH_KM),computePoint(RWY04_START,RWY04_HEADING+90,RWY_HALF_WIDTH_KM)],RWY22_POLY=[computePoint(RWY22_START,RWY22_HEADING-90,RWY_HALF_WIDTH_KM),computePoint(RWY22_END,RWY22_HEADING-90,RWY_HALF_WIDTH_KM),computePoint(RWY22_END,RWY22_HEADING+90,RWY_HALF_WIDTH_KM),computePoint(RWY22_START,RWY22_HEADING+90,RWY_HALF_WIDTH_KM)];function buildExtendedCenterlinePoly(t,e,o,a){const n=computePoint(t,e,a),i=computePoint(t,e-90,o),r=computePoint(t,e+90,o),l=computePoint(n,e-90,o),s=computePoint(n,e+90,o);return[i,l,s,r]}const RWY04_EXT_POLY=buildExtendedCenterlinePoly(RWY04_END,RWY04_HEADING,.5,6),RWY22_EXT_POLY=buildExtendedCenterlinePoly(RWY22_END,RWY22_HEADING,.5,6);let HEATMAP_ENABLED=!0,CORRIDOR_ENABLED=!0,TRACKS_ENABLED=!0,SONOS_ENABLED=!0,corridorLayer=null,heatLayer=null;function updateSonometersVisibility(){SONO_MARKERS.forEach(t=>{SONOS_ENABLED?map.hasLayer(t.marker)||t.marker.addTo(map):map.hasLayer(t.marker)&&map.removeLayer(t.marker)}),!SONOS_ENABLED&&f017MarkerAbove&&(map.removeLayer(f017MarkerAbove),f017MarkerAbove=null)}function hideAllTracks(){Object.values(ADSB_TRACKS).forEach(t=>{t.poly&&(map.removeLayer(t.poly),t.poly=null)})}
/* ====== SVG PLANE ICON (rotated with heading) ====== */
const PLANE_ICON=t=>L.divIcon({html:`<svg width="28" height="28" viewBox="0 0 24 24" style="transform:rotate(${t}deg)"><path d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z" fill="#f97316"/></svg>`,className:"plane-icon",iconSize:[28,28],iconAnchor:[14,14]});
/* ====== Inject Legend ====== */
(function(){const t=document.createElement("div");t.id="legend",t.style="position:absolute;bottom:20px;left:20px;background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.25);font-size:14px;z-index:9999";t.innerHTML='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><svg width="22" height="22" viewBox="0 0 24 24" style="transform:rotate(45deg)"><path d="M2.5 19l8.5-7-8.5-7v5l6 2-6 2zM11 22l4-20h-2l-4 20h2zm5.5-3l6-2-6-2 6-2V5l-8.5 7 8.5 7v-5z" fill="#f97316"/></svg><span>Avion (ADS‑B)</span></div><div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#ef4444;border-radius:50%;display:inline-block"></span><span>Sonomètre impacté</span></div>',map.getContainer().appendChild(t)})();
let ADSB_MARKERS={},ADSB_TRACKS={};async function fetchADSB(){const t="https://opensky-network.org/api/states/all?lamin=50.3&lomin=5.1&lamax=50.9&lomax=5.8";try{const e=await fetch(t),o=await e.json();return o.states||[]}catch(t){return[]}}function updateADSB(t){t.forEach(t=>{const e=t[0],o=(t[1]||"").trim(),a=t[5],n=t[6],i=t[10]||0;if(null==n||null==a)return;ADSB_MARKERS[e]?(ADSB_MARKERS[e].setLatLng([n,a]),ADSB_MARKERS[e].setIcon(PLANE_ICON(i))):(ADSB_MARKERS[e]=L.marker([n,a],{icon:PLANE_ICON(i)}).addTo(map).bindPopup(`ICAO: ${e}<br>Callsign: ${o}`));ADSB_TRACKS[e]||(ADSB_TRACKS[e]=[]),ADSB_TRACKS[e].push([n,a]),ADSB_TRACKS[e].length>40&&ADSB_TRACKS[e].shift(),ADSB_TRACKS[e].poly&&(map.removeLayer(ADSB_TRACKS[e].poly),ADSB_TRACKS[e].poly=null),TRACKS_ENABLED&&(ADSB_TRACKS[e].poly=L.polyline(ADSB_TRACKS[e],{color:"#fbbf24",weight:2}).addTo(map));const r=normalizeCallsign(o);r&&(ADSB_BY_CALLSIGN[r]={icao:e,marker:ADSB_MARKERS[e]},ADSB_MARKERS[e].off("click"),ADSB_MARKERS[e].on("click",()=>{if(!LAST_FIDS)return;const t=[...(LAST_FIDS.arrivals||[]),...(LAST_FIDS.departures||[])],e=t.find(t=>normalizeCallsign(t.flightPax||t.flight||t.callsign)===r);e&&showFlightDetail(e)}))}),detectTakeoff04(t),detectTakeoff22(t),lastRunway&&colorSonoByRunway(lastRunway),updateF017Icon(),annotateFlightsWithADSB()}function annotateFlightsWithADSB(){try{const t=document.getElementById("flights-list");t&&t.querySelectorAll(".flight-row").forEach(t=>{const e=t.getAttribute("data-normcallsign"),o=t.querySelector(".adsb-badge"),a=e&&!!ADSB_BY_CALLSIGN[e];o&&(o.textContent=a?"ADS‑B OK":"—",o.style.background=a?"#10b981":"#d1d5db",o.style.color=a?"#fff":"#111")})}catch(t){}}function focusAircraftByCallsign(t,e){const o=t?ADSB_BY_CALLSIGN[t]:null;if(o&&o.marker){const t=o.marker,e=t.getLatLng();map.setView(e,13),t.openPopup();const a=L.circle(e,{radius:150,color:"#22c55e",weight:2,fillOpacity:.1});a.addTo(map),setTimeout(()=>map.removeLayer(a),2500)}else highlightFlightOnMap(e)}async function fetchMetar(){const t=`https://avwx.rest/api/metar/EBLG?token=${AVWX_TOKEN}&format=json`,e=await fetch(t);return e.json()}function updateMetarUI(t){document.getElementById("meteo-summary").textContent=`Vent ${t.wind_direction.value}° / ${t.wind_speed.value} kt – T° ${t.temperature.value}°C`,document.getElementById("meteo-raw").textContent=t.raw}function formatLocal(t){return t?new Date(t).toLocaleTimeString("fr-BE",{hour:"2-digit",minute:"2-digit",hour12:!1}):"-"}async function fetchFIDS(){const t=await fetch(URL_ARR).then(t=>t.json()),e=await fetch(URL_DEP).then(t=>t.json());return{arrivals:Array.isArray(t)?t:[],departures:Array.isArray(e)?e:[]}}function setFilter(t){FLT_FILTER=t,refresh()}function updateFlightsUI(t){LAST_FIDS=t;const e=document.getElementById("flights-list");let o=[...t.arrivals,...t.departures];"ARR"===FLT_FILTER&&(o=o.filter(t=>"Arrivals"===t.direction)),"DEP"===FLT_FILTER&&(o=o.filter(t=>"Departures"===t.direction)),o.sort((t,e)=>new Date(t.sTx)-new Date(e.sTx)),o=o.slice(0,10),o.length?(e.innerHTML=o.map(t=>{const e=t.flightPax||t.flight||t.callsign||"",a=normalizeCallsign(e),n=a&&!!ADSB_BY_CALLSIGN[a],i=t.runway||"?";return`<div class="flight-row" data-id="${t.id}" data-normcallsign="${a}">${"Arrivals"===t.direction?"ARR":"DEP"} ${e} (${t.aircraftType}) – RWY ${i} <span class="tag adsb-badge" style="margin-left:6px; ${n?"background:#10b981;color:#fff;":""}">${n?"ADS‑B OK":"—"}</span><br>${formatLocal(t.sTx)} → ${formatLocal(t.eTx)}</div>`}).join(""),e.querySelectorAll(".flight-row").forEach(t=>{t.onclick=()=>{const e=t.getAttribute("data-id"),a=t.getAttribute("data-normcallsign"),n=o.find(t=>t.id===e);n&&showFlightDetail(n),focusAircraftByCallsign(a,n)}}),annotateFlightsWithADSB()):e.textContent="Aucun vol."}function showFlightDetail(t){document.getElementById("flight-detail").innerHTML=`<strong>${t.flightPax}</strong> – ${t.aircraftType}<br>${t.origin} → ${t.destination}<br>Piste : ${t.runway||"-"}<br>STD/STA : ${formatLocal(t.sTx)}<br>ETD/ETA : ${formatLocal(t.eTx)}<br>ATD/ATA : ${formatLocal(t.aTx)}<br>Stand : ${t.stand||"-"}<br>Opérateur : ${t.operator||"-"}`}function highlightFlightOnMap(t){if(!t)return;const e=[EBLG.lat+.005,EBLG.lon+.005];window.flightMarker&&map.removeLayer(window.flightMarker),window.flightMarker=L.circleMarker(e,{radius:10,color:"#f97316",fillColor:"#f97316",fillOpacity:.9}).addTo(map).bindPopup(`Vol ${t.flightPax}`),map.setView(e,13)}function extractRunway(t){const e=[...t.arrivals,...t.departures],o=e.find(t=>t.runway);if(!o)return null;const a=o.runway.replace(/[^0-9]/g,"");return EBLG.runways.find(t=>t.name===a)||null}function runwayFromMetar(t){if(!t||!t.wind_direction||null==t.wind_direction.value)return null;const e=t.wind_direction.value;let o=null,a=999;return EBLG.runways.forEach(t=>{const n=Math.min(Math.abs(e-t.heading),360-Math.abs(e-t.heading));n<a&&(a=n,o=t)}),o}function buildCorridor(t){const e=[EBLG.lat,EBLG.lon],o=computePoint(e,t,20),a=computePoint(e,t-90,1.5),n=computePoint(e,t+90,1.5),i=computePoint(o,t-90,3.5),r=computePoint(o,t+90,3.5);return[a,i,r,n]}function colorSonoByRunway(t){SONO_MARKERS.forEach(e=>{let o={color:COLOR.gray,fillColor:COLOR.gray};if("F017"===e.id)"04"===t&&IS_TAKEOFF_04?o={color:COLOR.red,fillColor:COLOR.red}:"22"===t&&!IS_TAKEOFF_22?o={color:COLOR.green,fillColor:COLOR.green}:"04"===t&&!IS_TAKEOFF_04&&(o={color:COLOR.green,fillColor:COLOR.green});else if("22"===t)IS_TAKEOFF_22&&RW22_TKOFF_GREEN.has(e.id)&&(o={color:COLOR.green,fillColor:COLOR.green});else if("04"===t)IS_TAKEOFF_04?RW04_BOTH_GREEN.has(e.id)&&(o={color:COLOR.green,fillColor:COLOR.green}):RW04_LDG_GREEN.has(e.id)||RW04_BOTH_GREEN.has(e.id)?o={color:COLOR.green,fillColor:COLOR.green}:RW04_LDG_IMP_RED.has(e.id)&&(o={color:COLOR.red,fillColor:COLOR.red});e.marker.setStyle({...o,fillOpacity:1})})}function computeImpacted(t){const e=buildCorridor(t);corridorLayer&&map.removeLayer(corridorLayer),CORRIDOR_ENABLED?corridorLayer=L.polygon(e,{color:"#f97316",weight:2,fillOpacity:.15}).addTo(map):corridorLayer=null;const o=[];return SONO_MARKERS.forEach(t=>{L.polygon(e).getBounds().contains([t.lat,t.lon])&&o.push(t)}),o}function updateHeatmap(t){if(!HEATMAP_ENABLED)return void(heatLayer&&(map.removeLayer(heatLayer),heatLayer=null));const e=SONOS.map(e=>{const o=t.find(t=>t.id===e.id);return[e.lat,e.lon,o?1.5:.3]});heatLayer&&map.removeLayer(heatLayer),window.L&&L.heatLayer&&(heatLayer=L.heatLayer(e,{radius:40,blur:25,maxZoom:12}).addTo(map))}const HUB_URL="https://eblg.aerovision.cloud/EBLG/signalr-noise",SENSOR_MAP={1:"F001",2:"F002",3:"F003",4:"F004",5:"F005",6:"F006",7:"F007",8:"F008",9:"F009",10:"F010",11:"F011",12:"F012",13:"F013",14:"F014",15:"F015",16:"F016",17:"F017"};let LIVE_NOISE={},HISTORY_DURATION_MS=3e5,NOISE_HISTORY={};SONOS.forEach(t=>NOISE_HISTORY[t.id]=[]);let CHARTS={};const connection=new signalR.HubConnectionBuilder().withUrl(HUB_URL).withAutomaticReconnect().build();function updateNoiseUI(t){const e=document.getElementById("noise-live");t&&t.length?e.innerHTML=t.sort((t,e)=>t.id>e.id?1:-1).map(t=>`<div><strong>${t.id}</strong> : ${null!=t.laeq?t.laeq:"n/d"} dB(A)</div>`).join(""):e.textContent="Aucune donnée."}function updateHistoryChart(t){const e=document.getElementById(`chart_${t}`);if(!e)return;const o=NOISE_HISTORY[t],a=o.map(t=>new Date(t.t).toLocaleTimeString("fr-BE",{minute:"2-digit",second:"2-digit"})),n=o.map(t=>t.v);CHARTS[t]?((CHARTS[t].data.labels=a),(CHARTS[t].data.datasets[0].data=n),CHARTS[t].update()):CHARTS[t]=new Chart(e.getContext("2d"),{type:"line",data:{labels:a,datasets:[{label:"LAeq (dB)",data:n,borderColor:"#2563eb",backgroundColor:"rgba(37,99,235,0.2)",tension:.25,borderWidth:2,pointRadius:0}]},options:{animation:!1,scales:{x:{display:!0},y:{min:20,max:90}},plugins:{legend:{display:!1}}}})}connection.on("addNoiseMeasure",(t,e)=>{const o=SENSOR_MAP[t]||`ID_${t}`;LIVE_NOISE[o]={laeq:e.value,t:new Date(e.timeStamp).toISOString()};const a=Date.now();NOISE_HISTORY[o].push({t:a,v:e.value}),NOISE_HISTORY[o]=NOISE_HISTORY[o].filter(t=>a-t.t<=HISTORY_DURATION_MS),updateHistoryChart(o),updateNoiseUI(Object.entries(LIVE_NOISE).map(([t,e])=>({id:t,laeq:e.laeq,t:e.t})));const n=document.getElementById(`lv_${o}`);n&&(n.textContent=`niveau: ${e.value} dB(A)`)}),connection.start().catch(console.error);function computeAlerts(t,e){const o=[];t&&t.wind_speed&&t.wind_speed.value>25&&o.push("Vent fort (>25 kt)"),t&&t.wind_gust&&t.wind_gust.value>35&&o.push("Rafales (>35 kt)"),e&&t&&t.wind_direction&&Math.abs(t.wind_direction.value-e.heading)>150&&Math.abs(t.wind_direction.value-e.heading)<210&&o.push("Vent arrière"),lastRunway&&e&&lastRunway!==e.name&&o.push(`Changement piste : ${lastRunway} → ${e.name}`),lastRunway=e?e.name:null,document.getElementById("alerts").innerHTML=o.length?o.map(t=>`<div>⚠️ ${t}</div>`).join(""):"Aucune alerte."}const MS2KT=1.943844,M2FT=3.28084,HEADING_TOL=15,ROLL_GS_KT=70,FAST_TAXI_KT=40,VR_GS_KT=110,CLIMB_MAX_ALT_FT=200,CENTERLINE_MAX_OFFSET_KM=.5;let IS_TAKEOFF_04=!1,lastTakeoffTime04=0,IS_TAKEOFF_22=!1,lastTakeoffTime22=0,VR_DETECTED=!1,VR_LOCATION=null,VR_MARKER=null;const TAKEOFF_ICON=L.divIcon({html:"✈️⬆️",className:"takeoff-icon",iconSize:[30,30],iconAnchor:[15,15]});!function(){const t=document.createElement("style");t.textContent=".takeoff-icon{font-size:28px;color:#dc2626;text-shadow:0 0 4px rgba(0,0,0,.6);}",document.head.appendChild(t)}();let f017MarkerAbove=null;function showToast(t,e="#dc2626"){const o=document.createElement("div");o.style.position="fixed",o.style.top="20px",o.style.right="20px",o.style.background=e,o.style.color="white",o.style.padding="12px 18px",o.style.borderRadius="6px",o.style.fontSize="16px",o.style.boxShadow="0 4px 10px rgba(0,0,0,0.3)",o.style.zIndex=99999,o.style.opacity="0",o.style.transition="opacity .2s",o.textContent=t,document.body.appendChild(o),requestAnimationFrame(()=>{o.style.opacity="1"}),setTimeout(()=>{o.style.opacity="0",setTimeout(()=>o.remove(),600)},3500)}function showTakeoffNotification04(t){showToast(`Décollage RWY 04 détecté : ${t}`,"#dc2626")}function updateF017Icon(){const t=SONOS.find(t=>"F017"===t.id);t&&(IS_TAKEOFF_04?f017MarkerAbove||(f017MarkerAbove=L.marker([t.lat,t.lon],{icon:TAKEOFF_ICON}).addTo(map)):f017MarkerAbove&&(map.removeLayer(f017MarkerAbove),f017MarkerAbove=null))}let F017_SURVEY_START=null,F017_SURVEY_ACTIVE=!1;function checkF017Overflight(t,e){const o=SONOS.find(t=>"F017"===t.id);if(!o)return;const a=distanceKm(t,e,o.lat,o.lon);if(!IS_TAKEOFF_04)return F017_SURVEY_ACTIVE&&F017_SURVEY_START&&showToast(`Survol F017 terminé – durée ${((Date.now()-F017_SURVEY_START)/1e3).toFixed(1)} s`,"#0ea5e9"),void(F017_SURVEY_ACTIVE=!1,F017_SURVEY_START=null);a<.5?F017_SURVEY_ACTIVE||(F017_SURVEY_ACTIVE=!0,F017_SURVEY_START=Date.now()):F017_SURVEY_ACTIVE&&F017_SURVEY_START&&(showToast(`Survol F017 terminé – durée ${((Date.now()-F017_SURVEY_START)/1e3).toFixed(1)} s`,"#0ea5e9"),F017_SURVEY_ACTIVE=!1,F017_SURVEY_START=null)}function angleDiff(t,e){let o=Math.abs(t-e)%360;return o>180&&(o=360-o),o}function detectTakeoff04(t){let e=!1;for(const o of t){const t=(o[1]||"").trim(),a=o[5],n=o[6];if(null==n||null==a)continue;const i=o[9]||0,r=null!=o[10]?o[10]:null,l=null!=o[11]?o[11]:null,s=null!=o[13]?o[13]:null!=o[7]?o[7]:0,d=i*MS2KT,c=(s||0)*M2FT,u=normalizeCallsign(t);let h=null;LAST_FIDS&&LAST_FIDS.departures&&(h=LAST_FIDS.departures.find(t=>normalizeCallsign(t.flightPax||t.flight||t.callsign)===u&&(t.runway||"").includes("04")));if(!h)continue;const f=pointInPolygon([n,a],RWY04_POLY),m=null!=r?angleDiff(r,RWY04_HEADING)<=HEADING_TOL:!0,p=distancePointToSegmentKm([n,a],RWY04_START,RWY04_END)<=CENTERLINE_MAX_OFFSET_KM,g=f&&m&&d>=ROLL_GS_KT,y=!f&&m&&d>=ROLL_GS_KT&&c>0&&c<=CLIMB_MAX_ALT_FT&&p;!VR_DETECTED&&f&&m&&d>=VR_GS_KT&&(c<50||null!=l&&l>.5)&&(VR_DETECTED=!0,VR_LOCATION=[n,a],VR_MARKER&&map.removeLayer(VR_MARKER),VR_MARKER=L.circleMarker(VR_LOCATION,{radius:8,color:"#22d3ee",fillColor:"#22d3ee",fillOpacity:.9}).addTo(map).bindPopup("Rotation Point (VR)"));if(g||y){e=!0,IS_TAKEOFF_04||showTakeoffNotification04(t||"—"),IS_TAKEOFF_04=!0,lastTakeoffTime04=Date.now(),checkF017Overflight(n,a)}}!e&&IS_TAKEOFF_04&&Date.now()-lastTakeoffTime04>2e4&&(IS_TAKEOFF_04=!1,F017_SURVEY_ACTIVE&&F017_SURVEY_START&&showToast(`Survol F017 terminé – durée ${((Date.now()-F017_SURVEY_START)/1e3).toFixed(1)} s`,"#0ea5e9"),F017_SURVEY_ACTIVE=!1,F017_SURVEY_START=null)}function detectTakeoff22(t){let e=!1;for(const o of t){const t=(o[1]||"").trim(),a=o[5],n=o[6];if(null==n||null==a)continue;const i=o[9]||0,r=null!=o[10]?o[10]:null,l=null!=o[13]?o[13]:null!=o[7]?o[7]:0,s=i*MS2KT,d=(l||0)*M2FT,c=normalizeCallsign(t);let u=null;LAST_FIDS&&LAST_FIDS.departures&&(u=LAST_FIDS.departures.find(t=>normalizeCallsign(t.flightPax||t.flight||t.callsign)===c&&(t.runway||"").includes("22")));if(!u)continue;const h=pointInPolygon([n,a],RWY22_POLY),f=null!=r?angleDiff(r,RWY22_HEADING)<=HEADING_TOL:!0,m=distancePointToSegmentKm([n,a],RWY22_START,RWY22_END)<=CENTERLINE_MAX_OFFSET_KM,p=h&&f&&s>=ROLL_GS_KT,g=!h&&f&&s>=ROLL_GS_KT&&d>0&&d<=CLIMB_MAX_ALT_FT&&m;(p||g)&&(e=!0,IS_TAKEOFF_22=!0,lastTakeoffTime22=Date.now())}!e&&IS_TAKEOFF_22&&Date.now()-lastTakeoffTime22>2e4&&(IS_TAKEOFF_22=!1)}async function refresh(){const t=await fetchMetar().catch(()=>null);t&&updateMetarUI(t);const e=await fetchFIDS().catch(()=>({arrivals:[],departures:[]}));updateFlightsUI(e);const o=extractRunway(e),a=t?runwayFromMetar(t):null,n=o||a;if(n){document.getElementById("runway-info").textContent=`Piste ${n.name} – cap ${n.heading}°`,null==lastHeading&&(lastHeading=n.heading),lastHeading+=(n.heading-lastHeading)*.1,colorSonoByRunway(n.name);const i=computeImpacted(lastHeading);updateHeatmap(i),document.getElementById("sonos-impacted").innerHTML=i.length?i.map(t=>`<span class="tag impacted">${t.id}</span>`).join(" "):"Aucun impacté",computeAlerts(t||{},n),lastRunway=n.name}else document.getElementById("runway-info").textContent="Piste indéterminée.";const i=await fetchADSB().catch(()=>[]);updateADSB(i),updateF017Icon()}const btnHeat=document.getElementById("toggle-heatmap");btnHeat&&(btnHeat.onclick=()=>{HEATMAP_ENABLED=!HEATMAP_ENABLED,btnHeat.textContent=`Heatmap : ${HEATMAP_ENABLED?"ON":"OFF"}`,btnHeat.classList.toggle("off",!HEATMAP_ENABLED),!HEATMAP_ENABLED&&heatLayer&&(map.removeLayer(heatLayer),heatLayer=null)});const btnCorr=document.getElementById("toggle-corridor");btnCorr&&(btnCorr.onclick=()=>{CORRIDOR_ENABLED=!CORRIDOR_ENABLED,btnCorr.textContent=`Corridor : ${CORRIDOR_ENABLED?"ON":"OFF"}`,btnCorr.classList.toggle("off",!CORRIDOR_ENABLED),!CORRIDOR_ENABLED&&corridorLayer&&(map.removeLayer(corridorLayer),corridorLayer=null)});const btnTracks=document.getElementById("toggle-tracks");btnTracks&&(btnTracks.onclick=()=>{TRACKS_ENABLED=!TRACKS_ENABLED,btnTracks.textContent=`Trajectoires ADS‑B : ${TRACKS_ENABLED?"ON":"OFF"}`,btnTracks.classList.toggle("off",!TRACKS_ENABLED),TRACKS_ENABLED||hideAllTracks()});const btnSonos=document.getElementById("toggle-sonos");btnSonos&&(btnSonos.onclick=()=>{SONOS_ENABLED=!SONOS_ENABLED,btnSonos.textContent=`Sonomètres : ${SONOS_ENABLED?"ON":"OFF"}`,btnSonos.classList.toggle("off",!SONOS_ENABLED),updateSonometersVisibility()});function resetMap(){map.setView([EBLG.lat,EBLG.lon],11),map.closePopup(),window.flightMarker&&(map.removeLayer(window.flightMarker),window.flightMarker=null),HEATMAP_ENABLED||!heatLayer||(map.removeLayer(heatLayer),heatLayer=null),CORRIDOR_ENABLED||!corridorLayer||(map.removeLayer(corridorLayer),corridorLayer=null),TRACKS_ENABLED||hideAllTracks(),updateSonometersVisibility()}const btnReset=document.getElementById("reset-map");btnReset&&(btnReset.onclick=()=>{resetMap()});refresh(),setInterval(refresh,6e4);
</script>
  
</body>
</html>













